<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Zowar (ÿ≤ŸèŸàŸëÿßÿ±) - Firebase Ÿà ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿØÿ±Ÿäÿ≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        // These are the V9 modular SDKs
        // const firebase = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
        // const auth = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
        // const firestore = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        // const analytics = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js");
        // For this prototype, we'll mock Firebase interactions to keep it client-side in a single file.
        // In a real app, you would uncomment the above and use the actual Firebase services.
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <!-- Visualization & Content Choices: 
        - Firebase: Config included. Mock functions for auth (signInAnonymously) and Firestore (getDoc, setDoc, etc.) to interact with local mockData.
        - Tutoring Section: Cards for school subjects (Math, Science, etc.). Clicking a subject shows a placeholder.
        - Section Theming: Distinct background/accent for each section. Home icon changed to üè†.
        - All existing features (Posts, Stories, Search, Chat, AI features) refined for consistency.
    -->
    <style>
        :root {
            --bg-primary-global: #FDFEFF; 
            --text-primary-global: #1A202C; 
            --accent-primary-global: #071A50; 
            --accent-secondary-global: #1DBFAF; 
            --highlight-gold-global: #F0B90B; 
            --border-color-global: #EAEEF3; 
            --danger-color-global: #E53E3E;

            --dark-bg-primary-global: #0D1117; 
            --dark-text-primary-global: #E6EDF3;
            --dark-accent-primary-global: #79C0FF; 
            --dark-accent-secondary-global: #58A6FF; 
            --dark-highlight-gold-global: #F2CC8F; 
            --dark-border-color-global: #30363D;
            --dark-danger-color-global: #F85149;

            /* Section Specific Themes (Light Mode) */
            --home-bg: linear-gradient(135deg, #E0F7FA 0%, #E8F5E9 100%); /* Light Blue to Light Green */
            --home-accent: #26A69A; /* Teal variant */
            --explore-bg: linear-gradient(135deg, #FFFDE7 0%, #FFF3E0 100%); /* Light Yellow to Light Orange */
            --explore-accent: #FFA000; /* Amber */
            --tutoring-bg: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); /* Light Purple */
            --tutoring-accent: #8E24AA; /* Purple */
            --profile-bg: linear-gradient(135deg, #E3F2FD 0%, #E8EAF6 100%); /* Light Blue to Indigo */
            --profile-accent: var(--accent-primary-global);
            --messages-bg: linear-gradient(135deg, #E0F2F1 0%, #E0F7FA 100%);
            --messages-accent: #00897B; 

            /* Section Specific Themes (Dark Mode) */
            --dark-home-bg: linear-gradient(135deg, #1A222C 0%, #1B2F2A 100%);
            --dark-home-accent: #4DB6AC;
            --dark-explore-bg: linear-gradient(135deg, #2C2A24 0%, #302D26 100%);
            --dark-explore-accent: var(--dark-highlight-gold-global);
            --dark-tutoring-bg: linear-gradient(135deg, #2C1D31 0%, #311B92 100%); /* Deep Purple */
            --dark-tutoring-accent: #CE93D8; /* Lighter Purple */
            --dark-profile-bg: linear-gradient(135deg, #1F243A 0%, #1A2035 100%);
            --dark-profile-accent: var(--dark-accent-primary-global);
            --dark-messages-bg: linear-gradient(135deg, #1A2B2A 0%, #1A2F32 100%);
            --dark-messages-accent: #26A69A;
        }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg-primary-global); 
            color: var(--text-primary-global); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.5s, color 0.5s; 
            font-smooth: antialiased; 
            -webkit-font-smoothing: antialiased; 
        }
        .dark-mode body { /* This class is added to body by JS */
            background-color: var(--dark-bg-primary-global);
            color: var(--dark-text-primary-global);
        }

        .app-container { max-width: 420px; margin: 0 auto; background-color: var(--bg-primary-global); min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.08); overflow: hidden; border-radius: 24px; }
        .dark-mode .app-container { background-color: var(--dark-bg-primary-global); }

        .main-content { flex-grow: 1; overflow-y: auto; padding-bottom: 75px; }
        
        .header-main { padding: 12px 16px; background-color: rgba(255,255,255,0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 1000; transition: background-color 0.4s; }
        .dark-mode .header-main { background-color: rgba(30,30,30,0.7); }
        .header-title { color: var(--accent-primary-global); font-weight: 900; font-size: 2.1rem; letter-spacing: -0.75px; }
        .dark-mode .header-title { color: var(--dark-accent-primary-global); }
        .header-icon-btn { font-size: 1.8rem; color: var(--text-secondary-global); transition: color 0.25s, transform 0.2s; cursor: pointer; position: relative; }
        .header-icon-btn:hover { color: var(--accent-primary-global); transform: scale(1.12); }
        .dark-mode .header-icon-btn { color: var(--dark-text-secondary-global); }
        .dark-mode .header-icon-btn:hover { color: var(--dark-accent-primary-global); }
        .unread-badge { position: absolute; top: -5px; right: -7px; background-color: var(--danger-color-global); color: white; font-size: 0.65rem; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; line-height: 1; box-shadow: 0 1px 6px rgba(229,62,62,0.6); }
        .dark-mode .unread-badge { background-color: var(--dark-danger-color-global); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 420px; margin: 0 auto; background-color: rgba(255,255,255,0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid var(--border-color-global); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -6px 30px rgba(0,0,0,0.05); z-index: 1000; transition: background-color 0.4s, border-color 0.4s; }
        .dark-mode .bottom-nav { background-color: rgba(30,30,30,0.7); border-top-color: var(--dark-border-color-global); }
        .nav-item { flex: 1; text-align: center; padding: 6px 0; cursor: pointer; color: var(--text-secondary-global); transition: color 0.3s ease-in-out, transform 0.2s ease-in-out; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active .nav-icon { /* Dynamic color set by JS */ transform: scale(1.2) translateY(-3px); }
        .nav-item.active .nav-text { /* Dynamic color set by JS */ font-weight: 700; }
        .nav-item:active { transform: scale(0.92); }
        .nav-icon { font-size: 1.9rem; margin-bottom: 0px; line-height: 1; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.3s; } 
        .nav-text { font-size: 0.65rem; margin-top: 3px; transition: color 0.3s; }
        .create-post-btn .nav-icon { 
            font-size: 2.8rem; 
            color: white; 
            background: linear-gradient(135deg, var(--accent-primary-global), var(--accent-secondary-global)); 
            border-radius: 50%; 
            width: 56px; height: 56px; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: translateY(-10px); 
        }
        .dark-mode .create-post-btn .nav-icon { background: linear-gradient(135deg, var(--dark-accent-primary-global), var(--dark-accent-secondary-global)); }
        .create-post-btn.active .nav-icon { transform: translateY(-10px) scale(1.1) rotate(135deg); }

        .section, .view { display: none; animation: sectionLoadAnimation 0.7s cubic-bezier(0.165, 0.84, 0.44, 1.0); }
        .section.active, .view.active { display: block; }
        @keyframes sectionLoadAnimation { from { opacity: 0; transform: translateY(30px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* Styles from previous version, adapted for new palette and refinements */
        .splash-screen, .story-circle, .post-card, .reel-card, .modal, .chat-bubble, .btn, .loading-indicator, .gemini-suggestion-item, .input-field, .voice-note-bubble, .zowar-space-card, .comment-item, .alert-banner, .user-search-item, .profile-header-bg, .profile-avatar-container, .comment-input-area { /* Retain and adapt existing styles, applying new CSS variables */ }
        
        .game-card {
            background-color: var(--bg-content);
            border-radius: 16px;
            padding: 20px; /* Increased padding */
            box-shadow: 0 8px 25px rgba(0,0,0,0.06);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color-global);
        }
        .dark-mode .game-card { background-color: var(--dark-bg-content); box-shadow: 0 8px 25px rgba(0,0,0,0.12); border-color: var(--dark-border-color-global); }
        .game-card:hover { transform: translateY(-6px) scale(1.04); box-shadow: 0 12px 35px rgba(0,0,0,0.08); }
        .game-card-icon { font-size: 3.5rem; margin-bottom: 16px; line-height: 1; color: var(--games-accent); }
        .dark-mode .game-card-icon { color: var(--dark-games-accent); }
        .game-card h3 { font-weight: 800; font-size: 1.2rem; color: var(--text-primary-global); margin-bottom: 6px; }
        .dark-mode .game-card h3 { color: var(--dark-text-primary-global); }
        .game-card p { font-size: 0.85rem; color: var(--text-secondary-global); }
        .dark-mode .game-card p { color: var(--dark-text-secondary-global); }

        .game-lobby-player { display: flex; align-items: center; padding: 10px; background-color: rgba(255,255,255,0.15); border-radius: 10px; margin-bottom: 10px; }
        .dark-mode .game-lobby-player { background-color: rgba(0,0,0,0.25); }
        .game-lobby-player img { width: 36px; height: 36px; border-radius: 50%; margin-left: 12px; border: 2px solid rgba(255,255,255,0.5); }
        .game-lobby-player span { font-size: 0.95rem; color: var(--text-primary-global); }
        .dark-mode .game-lobby-player span { color: var(--dark-text-primary-global); }


        .dice-container { display: flex; justify-content: center; align-items: center; perspective: 1000px; margin: 20px 0; min-height: 80px;}
        .dice { width: 70px; height: 70px; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); } /* Smoother roll */
        .dice-face { position: absolute; width: 70px; height: 70px; background-color: #fff; border: 2px solid #ddd; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; font-size: 28px; font-weight: bold; color: #333; border-radius: 6px; }
        .dark-mode .dice-face { background-color: #4A5568; border-color: #718096; color: #E2E8F0; }
        .face-1 { transform: rotateY(0deg) translateZ(35px); }
        .face-2 { transform: rotateY(90deg) translateZ(35px); }
        .face-3 { transform: rotateX(90deg) translateZ(35px); }
        .face-4 { transform: rotateX(-90deg) translateZ(35px); }
        .face-5 { transform: rotateY(-90deg) translateZ(35px); }
        .face-6 { transform: rotateY(180deg) translateZ(35px); }
        
        .basketball-court { width: 100%; max-width:300px; height: 220px; background: linear-gradient(to bottom, #F0E68C, #DEB887); border: 3px solid #8B4513; margin: 20px auto; position: relative; border-radius: 10px; overflow: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.2);}
        .hoop { width: 60px; height: 60px; border: 5px solid #CD5C5C; border-radius: 50%; position: absolute; top: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .net { width: 50px; height: 35px; border-left: 3px dashed #fff; border-right: 3px dashed #fff; border-bottom: 3px dashed #fff; position: absolute; top: 55px; left: 50%; transform: translateX(-50%); opacity: 0.8;}
        .ball { width: 35px; height: 35px; background: radial-gradient(circle at 10px 10px, #FFBF00, #FF8C00); border-radius: 50%; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.4); transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);}
        .ball.shooting { animation: shootAnimationPro 0.8s forwards cubic-bezier(0.3, 0, 0.1, 1); }
        @keyframes shootAnimationPro {
            0% { transform: translate(-50%, 0) scale(1); }
            40% { transform: translate(-50%, -150px) scale(0.85) rotate(90deg); }
            100% { transform: translate(-50%, -100px) scale(0.75) rotate(180deg); }
        }
        .tutoring-card {
            background-color: var(--bg-content);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color-global);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px; /* Ensure cards have some height */
        }
        .dark-mode .tutoring-card { background-color: var(--dark-bg-content); box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-color: var(--dark-border-color-global); }
        .tutoring-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .tutoring-card-icon { font-size: 2.8rem; margin-bottom: 12px; line-height: 1; color: var(--tutoring-accent); }
        .dark-mode .tutoring-card-icon { color: var(--dark-tutoring-accent); }
        .tutoring-card h3 { font-weight: 700; font-size: 1.1rem; color: var(--text-primary-global); }
        .dark-mode .tutoring-card h3 { color: var(--dark-text-primary-global); }

    </style>
</head>
<body class="dark-mode"> 
    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">Zowar</div>
        <div class="splash-subtitle">ÿ≤ŸèŸàŸëÿßÿ±</div>
        <div class="loading-indicator mt-12"></div>
    </div>

    <div class="app-container">
        <header class="header-main">
            <div class="flex justify-between items-center">
                <h1 class="header-title">Zowar</h1>
                <div class="flex items-center space-x-5 rtl:space-x-reverse">
                    <button id="open-search-modal-btn" class="header-icon-btn search-btn">‚åï</button> 
                    <button id="messages-header-btn" class="header-icon-btn messages-btn">
                        üì®
                        <span id="unread-messages-badge" class="unread-badge" style="display: none;">0</span>
                    </button> 
                </div>
            </div>
        </header>

        <main class="main-content">
            <section id="home-section" class="section active p-0">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">ÿßŸÑŸÇÿµÿµ</h2>
                        <span class="text-xs font-semibold cursor-pointer hover:underline" style="color: var(--home-accent);">ÿ¥ÿßŸáÿØ ÿßŸÑŸÉŸÑ</span>
                    </div>
                    <div id="stories-container" class="flex space-x-3 rtl:space-x-reverse overflow-x-auto pb-3 -mx-4 px-4">
                        </div>
                </div>
                <div id="posts-feed" class="px-2 sm:px-0">
                </div>
            </section>

            <section id="explore-section" class="section p-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-5">ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ</h2>
                <div class="mb-6 p-5 rounded-xl shadow-xl bg-gradient-to-r from-[var(--accent-secondary-global)] to-[var(--accent-primary-global)] text-white cursor-pointer transition-transform hover:scale-[1.02]" id="find-nearby-people-card">
                    <h3 class="text-lg font-bold mb-1">ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿßŸÑŸÇÿ±Ÿäÿ®ŸàŸÜ üìç</h3>
                    <p class="text-xs opacity-80">ÿßŸÉÿ™ÿ¥ŸÅ Ÿàÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸä Zowar ŸÅŸä ŸÖÿ≠Ÿäÿ∑ŸÉ.</p>
                </div>
                <div id="nearby-people-results" class="mb-8" style="display:none;">
                    <div class="loading-indicator border-top-[var(--accent-primary-global)]"></div>
                    <p class="text-center text-sm text-gray-500 dark:text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿ¥ÿÆÿßÿµ ŸÇÿ±Ÿäÿ®ŸäŸÜ...</p>
                    <div id="nearby-users-list" class="mt-4 space-y-3"></div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3"> Zowar Spaces <span class="text-xs px-2 py-0.5 bg-[var(--highlight-gold-global)] text-black rounded-full align-middle shadow-sm">ŸÖÿ®ÿßÿ¥ÿ±</span></h3>
                    <div id="zowar-spaces-container" class="space-y-4"></div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸäÿ©</h3>
                    <div id="geo-rooms-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                    <div class="mt-6 p-5 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h4 class="font-bold text-md text-[var(--accent-secondary-global)] dark:text-[var(--dark-accent-secondary-global)] mb-2">‚ú® ÿ£ŸÅŸÉÿßÿ± ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸáÿßŸÖÿü ÿØÿπ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸäŸÇÿ™ÿ±ÿ≠ ŸÖŸàÿßÿ∂Ÿäÿπ ÿ¥ŸäŸÇÿ©!
                        </p>
                        <button id="generate-icebreakers-btn" class="btn btn-secondary w-full text-sm">
                            üí° ÿßŸÇÿ™ÿ±ÿ≠ ŸÖŸàÿßÿ∂Ÿäÿπ ÿßŸÑÿ¢ŸÜ
                        </button>
                        <div id="loading-gemini" class="mt-4 text-center" style="display: none;">
                            <div class="loading-indicator border-top-[var(--accent-secondary-global)]"></div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">ÿ¨ÿßÿ±Ÿä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ£ŸÅŸÉÿßÿ±...</p>
                        </div>
                        <div id="icebreakers-suggestions" class="mt-5 text-sm space-y-3"></div>
                        <p id="gemini-error-message" class="mt-3 text-xs text-red-500 dark:text-red-400" style="display: none;"></p>
                    </div>
                </div>
            </section>
            
            <section id="games-section" class="section p-4">
                <h2 class="text-2xl font-extrabold text-gray-800 dark:text-gray-200 mb-6 text-center" style="color: var(--games-accent);">Zowar Play üéÆ</h2>
                <div class="grid grid-cols-2 gap-5">
                    <div class="game-card" data-game="ludo">
                        <div class="game-card-icon">üé≤</div>
                        <h3>ŸäŸÑÿß ŸÑŸàÿØŸà</h3>
                        <p>ŸÉŸÑÿßÿ≥ŸäŸÉŸäÿ© ŸÖŸÖÿ™ÿπÿ©</p>
                    </div>
                    <div class="game-card" data-game="dominoes">
                        <div class="game-card-icon" style="font-family: 'Arial Unicode MS', 'Lucida Sans Unicode', 'sans-serif'; font-size: 2.5rem;"> Domino</div>
                        <h3>ÿØŸàŸÖŸäŸÜŸà</h3>
                        <p>ÿ™ÿ≠ÿØŸä Ÿàÿ™ÿ±ŸÉŸäÿ≤</p>
                    </div>
                    <div class="game-card" data-game="snakes-ladders">
                        <div class="game-card-icon">üêç</div>
                        <h3>ÿ≠Ÿäÿ© ŸàÿØÿ±ÿ¨</h3>
                        <p>ÿ≠ÿ∏ ŸàŸÖÿ±ÿ≠</p>
                    </div>
                    <div class="game-card" data-game="basketball">
                        <div class="game-card-icon">üèÄ</div>
                        <h3>ÿ±ŸÖŸäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ©</h3>
                        <p>ÿßÿÆÿ™ÿ®ÿ± ÿØŸÇÿ™ŸÉ</p>
                    </div>
                    <div class="game-card" data-game="quiz">
                        <div class="game-card-icon">‚ùì</div>
                        <h3>ÿ£ÿ≥ÿ¶ŸÑÿ© ÿπÿßŸÖÿ©</h3>
                        <p>ÿ™ÿ≠ÿØŸä ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™</p>
                    </div>
                     <div class="game-card" data-game="challenges">
                        <div class="game-card-icon">üèÜ</div>
                        <h3>ÿ™ÿ≠ÿØŸäÿßÿ™ Zowar</h3>
                        <p>ÿ£ÿ´ÿ®ÿ™ ŸÖŸáÿßÿ±ÿ™ŸÉ</p>
                    </div>
                </div>
            </section>
            
            <section id="game-lobby-view" class="view p-4" style="background: var(--games-bg);">
                <button id="back-to-games-list-btn" class="mb-4 text-sm font-semibold" style="color: var(--games-accent);">‚ùÆ ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ£ŸÑÿπÿßÿ®</button>
                <h2 id="game-lobby-title" class="text-2xl font-bold text-center mb-6" style="color: var(--games-accent);"></h2>
                <div id="game-specific-ui" class="mb-6 p-4 bg-white/80 dark:bg-black/50 backdrop-blur-sm rounded-xl"></div>
                <div class="bg-white/80 dark:bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">ÿßŸÑŸÑÿπÿ® ŸÖÿπ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ° (4 ŸÑÿßÿπÿ®ŸäŸÜ)</h3>
                    <div id="game-lobby-players" class="space-y-2 mb-4">
                        </div>
                    <div class="flex space-x-2 rtl:space-x-reverse">
                        <button class="btn btn-secondary flex-1 text-sm" style="background-color: var(--games-accent);">‚ûï ÿØÿπŸàÿ© ÿµÿØŸäŸÇ</button>
                        <button class="btn btn-primary flex-1 text-sm" style="background-color: var(--accent-primary-global);">üöÄ ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®!</button>
                    </div>
                </div>
            </section>

            <section id="tutoring-section" class="section p-4">
                 <h2 class="text-2xl font-extrabold text-gray-800 dark:text-gray-200 mb-6 text-center" style="color: var(--tutoring-accent);">ŸÖÿ±ŸÉÿ≤ Zowar ÿßŸÑÿ™ÿπŸÑŸäŸÖŸä üìö</h2>
                 <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-8">ÿßŸÉÿ™ÿ¥ŸÅ ŸÖŸàÿßÿ±ÿØ ÿ™ÿπŸÑŸäŸÖŸäÿ© ŸàÿØÿ±Ÿàÿ≥ ÿÆÿµŸàÿµŸäÿ© ŸÅŸä ŸÖÿÆÿ™ŸÑŸÅ ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©.</p>
                 <div class="grid grid-cols-2 gap-5">
                    <div class="tutoring-card" data-subject="math">
                        <div class="tutoring-card-icon">üßÆ</div>
                        <h3>ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™</h3>
                    </div>
                    <div class="tutoring-card" data-subject="science">
                        <div class="tutoring-card-icon">üî¨</div>
                        <h3>ÿßŸÑÿπŸÑŸàŸÖ</h3>
                    </div>
                    <div class="tutoring-card" data-subject="arabic">
                        <div class="tutoring-card-icon">ÿ®</div>
                        <h3>ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</h3>
                    </div>
                    <div class="tutoring-card" data-subject="history">
                        <div class="tutoring-card-icon">üìú</div>
                        <h3>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</h3>
                    </div>
                    <div class="tutoring-card" data-subject="geography">
                        <div class="tutoring-card-icon">üåç</div>
                        <h3>ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸäÿß</h3>
                    </div>
                    <div class="tutoring-card" data-subject="english">
                        <div class="tutoring-card-icon">Aa</div>
                        <h3>ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©</h3>
                    </div>
                 </div>
                 <div id="tutoring-subject-details" class="mt-8 p-5 bg-white dark:bg-gray-800 rounded-xl shadow-lg" style="display:none;">
                    <h3 id="tutoring-subject-title" class="text-xl font-bold mb-3 text-center" style="color: var(--tutoring-accent);"></h3>
                    <p id="tutoring-subject-content" class="text-sm text-gray-700 dark:text-gray-300 text-center"></p>
                 </div>
            </section>


            <section id="create-post-section" class="section p-4 flex flex-col items-center justify-center">
                <div class="w-full max-w-md bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl">
                    <h2 class="text-xl font-bold text-center mb-6 text-gray-800 dark:text-gray-200">ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ</h2>
                    <div id="create-post-step1">
                        <label for="media-upload" class="block mb-4 text-sm font-medium text-gray-700 dark:text-gray-300">ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ£Ÿà ŸÅŸäÿØŸäŸà:</label>
                        <input type="file" id="media-upload" accept="image/*,video/*" class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 rtl:file:ml-4 file:py-2.5 file:px-5 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--accent-secondary-global)] file:text-white hover:file:bg-[var(--accent-secondary-global)]/90 cursor-pointer mb-6">
                        <button id="next-to-text-overlay-btn" class="btn btn-primary w-full">ÿßŸÑÿ™ÿßŸÑŸä</button>
                    </div>
                    <div id="create-post-step2" style="display:none;">
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">ŸÖÿπÿßŸäŸÜÿ© Ÿàÿ•ÿ∂ÿßŸÅÿ© ŸÜÿµ:</label>
                        <div class="post-media-container mb-4 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center min-h-[250px] relative">
                            <img id="post-preview-image" src="#" alt="Post preview" style="display:none;" class="max-h-[350px] rounded-lg object-contain">
                            <video id="post-preview-video" controls style="display:none;" class="max-h-[350px] rounded-lg object-contain"></video>
                            <p id="post-preview-placeholder" class="text-gray-400 dark:text-gray-500">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≥ÿßÿ¶ÿ∑ ŸÖÿÆÿ™ÿßÿ±ÿ©</p>
                            <div id="preview-text-overlay" class="post-text-overlay" style="display:none;"></div>
                        </div>
                        <textarea id="post-text-input" rows="2" class="input-field mb-4" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑŸÜÿµ ÿßŸÑÿ∞Ÿä ÿ≥Ÿäÿ∏Ÿáÿ± ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ©/ÿßŸÑŸÅŸäÿØŸäŸà..."></textarea>
                        <div class="mb-4">
                            <textarea id="post-caption-input" rows="3" class="input-field" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇŸãÿß ŸÑŸÖŸÜÿ¥Ÿàÿ±ŸÉ..."></textarea>
                            <button id="generate-caption-btn" class="mt-2 text-xs text-[var(--accent-secondary-global)] dark:text-[var(--dark-accent-secondary-global)] font-semibold hover:underline">‚ú® ÿßŸÇÿ™ÿ±ÿ≠ ÿ™ÿπŸÑŸäŸÇŸãÿß (AI)</button>
                            <div id="caption-loading-spinner" class="mt-1 text-xs text-gray-500 dark:text-gray-400" style="display:none;">ÿ¨ÿßÿ±Ÿä ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ™ÿπŸÑŸäŸÇ...</div>
                        </div>
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <button id="back-to-media-upload-btn" class="btn bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500 w-1/2">ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
                            <button id="submit-post-btn" class="btn btn-primary w-1/2">ŸÜÿ¥ÿ±</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="profile-section" class="section p-0 pt-0">
                 <div id="user-profile-content"></div>
            </section>
            
            <section id="other-user-profile-view" class="view p-0 pt-0">
                 <div id="other-user-profile-content"></div>
            </section>

            <section id="messages-view" class="view h-full flex flex-col">
                <header class="p-3 bg-gray-50 dark:bg-gray-800 flex items-center space-x-3 rtl:space-x-reverse shadow-sm border-b border-[var(--border-color-global)]">
                    <button id="back-to-main-from-messages" class="text-2xl text-gray-500 dark:text-gray-400 hover:text-[var(--accent-primary-global)]">‚ùÆ</button>
                    <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 flex-grow text-center">ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</h3>
                    <div class="w-8"></div> 
                </header>
                <div id="chat-list-view" class="flex-grow">
                    <div class="p-4 border-b border-[var(--border-color-global)]">
                        <input type="text" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™..." class="input-field">
                    </div>
                    <h2 class="text-md font-semibold text-gray-700 dark:text-gray-300 p-4 pb-2">ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿßŸÑŸÜÿ¥ÿ∑ŸàŸÜ</h2>
                     <div id="active-users-messages-container" class="flex space-x-3 rtl:space-x-reverse overflow-x-auto px-4 pb-4">
                        </div>
                    <h2 class="text-md font-semibold text-gray-700 dark:text-gray-300 p-4 pt-1">ŸÉŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</h2>
                    <div id="chat-list-items" class="divide-y divide-[var(--border-color-global)]">
                    </div>
                </div>
                <div id="chat-view" style="display: none;" class="h-full flex flex-col">
                    <header class="p-3 bg-gray-50 dark:bg-gray-800 flex items-center space-x-3 rtl:space-x-reverse shadow-sm border-b border-[var(--border-color-global)]">
                        <button id="back-to-chat-list" class="text-2xl text-gray-500 dark:text-gray-400 hover:text-[var(--accent-primary-global)]">‚ùÆ</button>
                        <img id="chat-view-avatar" src="https://placehold.co/40x40" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <div>
                            <h3 id="chat-view-name" class="font-semibold text-gray-800 dark:text-gray-200">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h3>
                            <p id="chat-view-status" class="text-xs text-green-500">ŸÜÿ¥ÿ∑ ÿßŸÑÿ¢ŸÜ</p>
                        </div>
                        <button class="mr-auto rtl:ml-auto rtl:mr-0 text-2xl text-[var(--accent-secondary-global)] hover:opacity-80" id="call-btn">‚úÜ</button>
                    </header>
                    <div id="chat-messages" class="flex-grow p-4 space-y-3 overflow-y-auto bg-gray-50 dark:bg-gray-900/40">
                    </div>
                    <div id="smart-reply-container" class="p-2 text-center space-x-1 rtl:space-x-reverse bg-gray-100 dark:bg-gray-800 border-t border-[var(--border-color-global)]" style="display:none;">
                    </div>
                    <footer class="p-3 bg-gray-100 dark:bg-gray-800 flex items-center border-t border-[var(--border-color-global)] space-x-2 rtl:space-x-reverse">
                        <button id="voice-note-btn" class="p-3 text-xl text-gray-500 dark:text-gray-400 hover:text-[var(--accent-secondary-global)]">üéôÔ∏è</button>
                        <input id="message-input" type="text" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ..." class="flex-grow p-3 rounded-full bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-[var(--accent-primary-global)] outline-none text-sm">
                        <button id="send-message-btn" class="p-3 text-2xl text-[var(--accent-primary-global)] dark:text-[var(--dark-accent-primary-global)] hover:opacity-80">‚û§</button>
                    </footer>
                    <div id="voice-recording-indicator" style="display:none;" class="p-3 bg-red-500 text-white text-center text-sm">
                        üî¥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ... <span id="voice-timer">0:00</span> (ÿßŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ)
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" data-section="home-section">
                <div class="nav-icon">üè†</div> <span class="nav-text">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
            </div>
            <div class="nav-item" data-section="explore-section">
                <div class="nav-icon">‚ú®</div> <span class="nav-text">ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ</span>
            </div>
            <div class="nav-item create-post-btn" data-section="create-post-section">
                <div class="nav-icon">‚äï</div> 
            </div>
            <div class="nav-item" data-section="games-section">
                <div class="nav-icon">üéÆ</div> <span class="nav-text">ÿ£ŸÑÿπÿßÿ®</span>
            </div>
            <div class="nav-item" data-section="tutoring-section">
                <div class="nav-icon">üìö</div> <span class="nav-text">ÿ™ÿØÿ±Ÿäÿ≥</span>
            </div>
            <div class="nav-item" data-section="profile-section" data-user-id="currentUser"> 
                <div class="nav-icon">‚óâ</div> <span class="nav-text">ŸÖŸÑŸÅŸä</span>
            </div>
        </nav>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h3>
                <button id="close-settings-modal" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body space-y-6">
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <label for="dark-mode-toggle" class="text-gray-700 dark:text-gray-300 text-sm font-medium">ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ</label>
                    <button id="dark-mode-toggle" class="w-14 h-7 bg-gray-300 dark:bg-gray-600 rounded-full p-1 flex items-center transition-colors duration-300 ease-in-out focus:outline-none ring-2 ring-transparent focus:ring-[var(--accent-primary-global)]">
                        <span class="w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out translate-x-0 dark:translate-x-7"></span>
                    </button>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <span class="text-gray-700 dark:text-gray-300 text-sm font-medium">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</span>
                    <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100">ŸÖŸÅÿπŸÑÿ©</span>
                </div>
                 <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <span class="text-gray-700 dark:text-gray-300 text-sm font-medium">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÉÿßŸÑŸÖÿßÿ™</span>
                     <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100">ŸÖŸÅÿπŸÑÿ©</span>
                </div>
                 <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <span class="text-gray-700 dark:text-gray-300 text-sm font-medium">ÿ¨ŸàÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±</span>
                     <span class="text-xs text-gray-500 dark:text-gray-400">ÿπÿßŸÑŸäÿ©</span>
                </div>
            </div>
            <button class="mt-10 w-full btn btn-primary">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
        </div>
    </div>
    
    <div id="calling-screen" class="fixed inset-0 bg-gradient-to-br from-[var(--accent-primary-global)] to-[#1c3faa] text-white flex flex-col items-center justify-center z-[5000] p-8" style="display:none;">
        <img id="calling-avatar" src="https://placehold.co/120x120/FFFFFF/0A2463?text=C" alt="Calling Avatar" class="w-32 h-32 rounded-full mb-6 border-4 border-white/50 shadow-2xl">
        <h2 id="calling-name" class="text-3xl font-extrabold mb-2 text-shadow">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿµŸÑ</h2>
        <p id="calling-status-text" class="text-lg text-white/80 mb-10">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...</p>
        <div class="flex space-x-6 rtl:space-x-reverse">
             <button class="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white font-bold p-4 rounded-full text-2xl w-16 h-16 flex items-center justify-center transition-all duration-200 ease-out hover:scale-110">üîá</button>
             <button id="end-call-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold p-4 rounded-full text-2xl w-20 h-20 flex items-center justify-center transform scale-110 shadow-lg transition-all duration-200 ease-out hover:scale-125">‚úÜ</button>
             <button class="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white font-bold p-4 rounded-full text-2xl w-16 h-16 flex items-center justify-center transition-all duration-200 ease-out hover:scale-110">üîä</button>
        </div>
    </div>
    
    <div id="ai-highlight-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title text-[var(--accent-secondary-global)] flex items-center">‚ú® ŸÖŸÑÿÆÿµ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä</h3>
                <button id="close-ai-highlight-modal" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="ai-summary-text" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
                    Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± Ÿäÿπÿ±ÿ∂ ŸÑŸÇÿ∑ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ© ŸÖŸÜ ÿ±ÿ≠ŸÑÿ© ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅŸäÿ© ÿ•ŸÑŸâ ÿ¨ÿ®ÿßŸÑ ÿßŸÑÿ£ŸÑÿ® ÿßŸÑÿ≥ŸàŸäÿ≥ÿ±Ÿäÿ©ÿå ŸÖÿπ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿßÿ∏ÿ± ÿßŸÑÿ∑ÿ®ŸäÿπŸäÿ© ÿßŸÑÿÆŸÑÿßÿ®ÿ© Ÿàÿ™ÿ¨ÿ±ÿ®ÿ© ÿ™ÿ≥ŸÑŸÇ ÿßŸÑÿ¨ÿ®ÿßŸÑ ÿßŸÑŸÖÿ´Ÿäÿ±ÿ©. ŸäŸÜÿµÿ≠ ÿ®Ÿá ŸÑÿπÿ¥ÿßŸÇ ÿßŸÑÿ∑ÿ®Ÿäÿπÿ© ŸàÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿßÿ™!
                </p>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content w-full h-full sm:h-auto sm:max-h-[80vh]">
            <div class="modal-header">
                <h3 class="modal-title">ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h3>
                <button id="close-search-modal-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input id="user-search-input" type="text" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ÿßŸÑÿßÿ≥ŸÖ..." class="input-field mb-4">
                <div id="search-results-container" class="space-y-3 max-h-[60vh] overflow-y-auto">
                    </div>
            </div>
        </div>
    </div>
        
    <div id="post-comments-modal" class="modal">
        <div class="modal-content w-full h-full sm:h-auto sm:max-h-[80vh]">
            <div class="modal-header">
                <h3 class="modal-title">ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±</h3>
                <button id="close-post-comments-modal-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="post-comments-list" class="space-y-3 mb-4 max-h-[50vh] overflow-y-auto">
                    </div>
                <div class="comment-input-area">
                    <input id="new-post-comment-input" type="text" placeholder="ÿ£ÿ∂ŸÅ ÿ™ÿπŸÑŸäŸÇŸãÿß..." class="input-field flex-grow">
                    <button id="submit-post-comment-btn" class="btn btn-secondary text-sm p-3 ml-2 rtl:mr-2 rtl:ml-0">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-banner" class="alert-banner">
        <span id="alert-message"></span>
    </div>


    <script>
        // Firebase Config (Provided by user - For a real app, keep this secure)
        const firebaseConfig = {
            apiKey: "AIzaSyCPIcg7RFGlslmgiO0C0miuYztPaxB5S2U", // IMPORTANT: In a real app, manage API keys securely.
            authDomain: "zowar-a9c69.firebaseapp.com",
            databaseURL: "https://zowar-a9c69-default-rtdb.firebaseio.com",
            projectId: "zowar-a9c69",
            storageBucket: "zowar-a9c69.appspot.com", // Corrected storage bucket
            messagingSenderId: "200949324467",
            appId: "1:200949324467:web:54e03ed49857e0af7caec6",
            measurementId: "G-XBMY1KN43S"
        };

        // Mock Firebase SDK for single-file prototype (replace with actual imports for real app)
        const mockFirebase = {
            initializeApp: (config) => { console.log("Firebase Mock Initialized:", config); return { name: "[DEFAULT]" }; },
            getAuth: () => ({ currentUser: { uid: "mockUserId", isAnonymous: true }, signInAnonymously: () => Promise.resolve({ user: { uid: "mockUserId", isAnonymous: true } }) }),
            getFirestore: () => ({
                doc: (db, path, id) => ({ path: `${path}/${id}` }),
                collection: (db, path) => ({ path }),
                getDoc: (docRef) => Promise.resolve({ exists: () => true, data: () => mockFirebase.mockDbData[docRef.path.split('/').pop()] || {} }), // Simulate getDoc
                setDoc: (docRef, data) => { console.log("Mock Firestore Set:", docRef.path, data); mockFirebase.mockDbData[docRef.path.split('/').pop()] = data; return Promise.resolve(); },
                addDoc: (collRef, data) => { const id = `mockDoc${Object.keys(mockFirebase.mockDbData).length}`; mockFirebase.mockDbData[id] = data; console.log("Mock Firestore Add:", collRef.path, id, data); return Promise.resolve({ id }); },
                onSnapshot: (query, callback) => { console.log("Mock onSnapshot registered for:", query.path); setTimeout(() => callback({ docs: Object.values(mockFirebase.mockDbData).map(d => ({ id: d.id || "mockId", data: () => d })) }), 100); return () => {}; }, // Simulate onSnapshot
            }),
            getAnalytics: () => ({ logEvent: (name, params) => console.log("Mock Analytics Event:", name, params) }),
            mockDbData: {} // Simple in-memory store for mock Firestore
        };

        const app = mockFirebase.initializeApp(firebaseConfig);
        const auth = mockFirebase.getAuth();
        const db = mockFirebase.getFirestore();
        // const analytics = mockFirebase.getAnalytics(app); // Uncomment if needed

        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selectors (Consolidated) ---
            const getEl = (id) => document.getElementById(id);
            const querySelAll = (sel) => document.querySelectorAll(sel);

            const splashScreen = getEl('splash-screen');
            const sections = querySelAll('.section');
            const views = querySelAll('.view');
            const navItems = querySelAll('.nav-item');
            const postsFeed = getEl('posts-feed'); 
            const aiHighlightModal = getEl('ai-highlight-modal');
            const closeAiHighlightModalBtn = getEl('close-ai-highlight-modal');
            
            const messagesHeaderBtn = getEl('messages-header-btn');
            const unreadMessagesBadge = getEl('unread-messages-badge');
            const messagesView = getEl('messages-view'); 
            const chatListView = getEl('chat-list-view'); 
            const chatView = getEl('chat-view'); 
            const chatListItems = getEl('chat-list-items'); 
            const backToChatListBtn = getEl('back-to-chat-list');
            const backToMainFromMessagesBtn = getEl('back-to-main-from-messages'); 
            const messageInput = getEl('message-input');
            const sendMessageBtn = getEl('send-message-btn');
            const voiceNoteBtn = getEl('voice-note-btn');
            const voiceRecordingIndicator = getEl('voice-recording-indicator');
            const voiceTimer = getEl('voice-timer');
            const smartReplyContainer = getEl('smart-reply-container');
            
            const settingsModal = getEl('settings-modal');
            const closeSettingsModalBtn = getEl('close-settings-modal');
            const darkModeToggleBtn = getEl('dark-mode-toggle');
            
            const callBtn = getEl('call-btn');
            const callingScreen = getEl('calling-screen');
            const endCallBtn = getEl('end-call-btn');
            
            const generateIcebreakersBtn = getEl('generate-icebreakers-btn');
            const icebreakersSuggestionsDiv = getEl('icebreakers-suggestions');
            const loadingGemini = getEl('loading-gemini');
            const geminiErrorMessageEl = getEl('gemini-error-message');
            
            const openSearchModalBtn = getEl('open-search-modal-btn');
            const searchModal = getEl('search-modal');
            const closeSearchModalBtn = getEl('close-search-modal-btn');
            const userSearchInput = getEl('user-search-input');
            const searchResultsContainer = getEl('search-results-container');
            
            const userProfileContent = getEl('user-profile-content');
            const otherUserProfileContent = getEl('other-user-profile-content');
            const otherUserProfileView = getEl('other-user-profile-view');
            
            const postCommentsModal = getEl('post-comments-modal');
            const closePostCommentsModalBtn = getEl('close-post-comments-modal-btn');
            const postCommentsList = getEl('post-comments-list');
            const newPostCommentInput = getEl('new-post-comment-input');
            const submitPostCommentBtn = getEl('submit-post-comment-btn');

            const alertBanner = getEl('alert-banner');
            const alertMessage = getEl('alert-message');

            const createPostStep1 = getEl('create-post-step1');
            const createPostStep2 = getEl('create-post-step2');
            const mediaUploadInput = getEl('media-upload');
            const nextToTextOverlayBtn = getEl('next-to-text-overlay-btn');
            const postPreviewImage = getEl('post-preview-image');
            const postPreviewVideo = getEl('post-preview-video');
            const postPreviewPlaceholder = getEl('post-preview-placeholder');
            const previewTextOverlay = getEl('preview-text-overlay');
            const postTextInput = getEl('post-text-input');
            const postCaptionInput = getEl('post-caption-input');
            const generateCaptionBtn = getEl('generate-caption-btn');
            const captionLoadingSpinner = getEl('caption-loading-spinner');
            const backToMediaUploadBtn = getEl('back-to-media-upload-btn');
            const submitPostBtn = getEl('submit-post-btn');
            let uploadedMediaFile = null;

            const findNearbyPeopleCard = getEl('find-nearby-people-card');
            const nearbyPeopleResults = getEl('nearby-people-results');
            const nearbyUsersList = getEl('nearby-users-list');
            const storiesContainer = getEl('stories-container') || querySelAll('#home-section .overflow-x-auto')[0];
            const zowarSpacesContainer = getEl('zowar-spaces-container') || querySelAll('#explore-section .mb-8 .space-y-4')[0];
            const geoRoomsGrid = getEl('geo-rooms-grid') || querySelAll('#explore-section > div:last-child .grid')[0]; 
            const activeUsersMessagesContainer = getEl('active-users-messages-container');

            const gamesSection = getEl('games-section');
            const gameLobbyView = getEl('game-lobby-view');
            const gameLobbyTitle = getEl('game-lobby-title');
            const gameSpecificUI = getEl('game-specific-ui');
            const gameLobbyPlayers = getEl('game-lobby-players');
            const backToGamesListBtn = getEl('back-to-games-list-btn');
            const tutoringSection = getEl('tutoring-section');
            const tutoringSubjectDetails = getEl('tutoring-subject-details');
            const tutoringSubjectTitle = getEl('tutoring-subject-title');
            const tutoringSubjectContent = getEl('tutoring-subject-content');


            let isRecording = false;
            let voiceRecordInterval;
            let voiceRecordSeconds = 0;
            let currentOpenPostIdForComment = null; 
            let unreadMessagesCount = 3; 

            let uiClickSynth, notificationSynth, messageSendSynth, callRingingSynth, callingProgressSynth, postSentSynth, gameSelectSynth, diceRollSynth, basketballShootSynth, quizCorrectSynth, quizWrongSynth;
            const masterVolume = -18; 

            // --- Mock Data (Moved to top for early access) ---
            const mockUsers = [
                { id: "currentUser", username: "zawar_king", displayName: "ŸÖŸÑŸÉ ÿßŸÑÿ≤Ÿàÿßÿ±", avatar: "https://source.unsplash.com/random/100x100?king,man,handsome", bio: "ÿ£ÿπŸäÿ¥ ÿßŸÑÿ≠Ÿäÿßÿ© ÿ®ŸÑÿ≠ÿ∏ÿßÿ™Ÿáÿßÿå ÿ£ÿ¥ÿßÿ±ŸÉŸÉŸÖ ÿ•ÿ®ÿØÿßÿπÿßÿ™Ÿä Ÿàÿ™ÿ¨ÿßÿ±ÿ®Ÿä ÿßŸÑŸÅÿ±ŸäÿØÿ©. Zowar ŸáŸà ÿπÿßŸÑŸÖŸä!", postsCount: 152, followers: 2580, following: 310, comments: [ {postId: 1, text: "ÿ•ÿ®ÿØÿßÿπ ŸÑÿß ŸäŸàÿµŸÅ!"}, {postId:2, text: "Ÿáÿ∞ÿß ŸÖÿß ŸÜÿ≠ÿ™ÿßÿ¨Ÿá ÿ™ŸÖÿßŸÖÿßŸã."} ] },
                { id: "user2", username: "explorer_ali", displayName: "ÿπŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ŸÉÿ¥ŸÅ", avatar: "https://source.unsplash.com/random/100x100?man,traveler,adventure", bio: "ÿ±ÿ≠ÿßŸÑÿ© ŸàŸÖÿµŸàÿ± ŸÅŸàÿ™Ÿàÿ∫ÿ±ÿßŸÅŸä. ÿ£ÿ¥ÿßÿ±ŸÉŸÉŸÖ ŸÖÿ∫ÿßŸÖÿ±ÿßÿ™Ÿä ÿ≠ŸàŸÑ ÿßŸÑÿπÿßŸÑŸÖ.", postsCount: 250, followers: 5200, following: 150, comments: [] },
                { id: "user3", username: "chef_fatima", displayName: "ÿßŸÑÿ¥ŸäŸÅ ŸÅÿßÿ∑ŸÖÿ©", avatar: "https://source.unsplash.com/random/100x100?woman,chef,food", bio: "ÿ£ÿπÿ¥ŸÇ ÿßŸÑÿ∑ÿ®ÿÆ ŸàŸÖÿ¥ÿßÿ±ŸÉÿ© ŸàÿµŸÅÿßÿ™Ÿä ÿßŸÑÿ¥ŸáŸäÿ©. ÿ™ÿßÿ®ÿπŸàŸÜŸä ŸÑÿ™ÿ∞ŸàŸÇ ÿßŸÑÿ•ÿ®ÿØÿßÿπ.", postsCount: 180, followers: 12300, following: 80, comments: [] },
                { id: "user4", username: "artist_omar", displayName: "ÿπŸÖÿ± ÿßŸÑŸÅŸÜÿßŸÜ", avatar: "https://source.unsplash.com/random/100x100?man,artist,painting", bio: "ÿ£ÿ±Ÿâ ÿßŸÑÿπÿßŸÑŸÖ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿπÿØÿ≥ÿ™Ÿä ŸàŸÅÿ±ÿ¥ÿßÿ™Ÿä. ÿßŸÑŸÅŸÜ ŸáŸà ÿ≠Ÿäÿßÿ™Ÿä.", postsCount: 310, followers: 8750, following: 220, comments: [] },
                { id: "user5", username: "sara_reads", displayName: "ÿ≥ÿßÿ±ÿ© ÿßŸÑŸÇÿßÿ±ÿ¶ÿ©", avatar: "https://source.unsplash.com/random/100x100?woman,book,library", bio: "ÿ£ÿπÿ¥ŸÇ ÿßŸÑŸÉÿ™ÿ® ŸàÿßŸÑŸÇÿ±ÿßÿ°ÿ©. ÿ£ÿ¥ÿßÿ±ŸÉ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™Ÿä Ÿàÿ™ŸàÿµŸäÿßÿ™Ÿä.", postsCount: 95, followers: 3100, following: 120, comments: [] }
            ];
            let mockPosts = [ 
                { id:1, type: 'image', userId: "user2", caption: "ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥ ÿßŸÑÿ≥ÿßÿ≠ÿ± ŸÖŸÜ ÿ¨ÿ®ÿßŸÑ ÿßŸÑÿ£ŸÜÿØŸäÿ≤. ŸÑÿß ÿ¥Ÿäÿ° Ÿäÿ∂ÿßŸáŸä Ÿáÿ∞ÿß ÿßŸÑÿ¨ŸÖÿßŸÑ! üåÖ #ÿ∑ÿ®Ÿäÿπÿ© #ÿ≥ŸÅÿ± #ŸÖÿ∫ÿßŸÖÿ±ÿ©", textOverlay: "ÿßŸÑÿ£ŸÜÿØŸäÿ≤ 2025", likes: 1850, commentsCount: 78, mediaUrl: "https://source.unsplash.com/random/600x800?andes,sunset", postComments: [{user: "ŸÜŸàÿ±", text: "ŸÖŸÜÿ∏ÿ± ŸäÿÆÿ∑ŸÅ ÿßŸÑÿ£ŸÜŸÅÿßÿ≥!"}, {user:"ÿ£ÿ≠ŸÖÿØ", text:"ÿ£ÿ™ŸÖŸÜŸâ ÿ≤Ÿäÿßÿ±ÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸÉÿßŸÜ ŸäŸàŸÖÿßŸã ŸÖÿß."}] },
                { id:2, type: 'video', userId: "user3", caption: "ŸÖŸÇÿ™ÿ∑ŸÅÿßÿ™ ŸÖŸÜ Ÿàÿ±ÿ¥ÿ© ÿπŸÖŸÑ ÿµŸÜÿßÿπÿ© ÿßŸÑÿ≠ŸÑŸàŸäÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÇŸäÿ©. ÿßÿ≥ÿ™ŸÖÿ™ÿπŸàÿß! üç∞üçØ #ÿ≠ŸÑŸàŸäÿßÿ™_ÿ¥ÿ±ŸÇŸäÿ© #ÿ∑ÿ®ÿÆ #ŸÅŸÜ", textOverlay: "Ÿàÿ±ÿ¥ÿ© ÿßŸÑÿ≠ŸÑŸàŸäÿßÿ™", likes: 1120, commentsCount: 130, mediaUrl: "https://dummyjson.com/video/1", postComments: [{user: "ÿ≥ÿßÿ±ÿ©", text: "ÿ™ÿ®ÿØŸà ŸÑÿ∞Ÿäÿ∞ÿ© ÿ¨ÿØÿßŸã!"}] }, 
                { id:3, type: 'image', userId: "currentUser", caption: "ŸÇŸáŸàÿ™Ÿä ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ© Ÿàÿ•ÿ∑ŸÑÿßŸÑÿ© ÿπŸÑŸâ ÿßŸÑŸÖÿØŸäŸÜÿ©. ÿ®ÿØÿßŸäÿ© ŸäŸàŸÖ ŸÖÿ´ÿßŸÑŸäÿ©! ‚òïÔ∏èüèôÔ∏è #ÿµÿ®ÿßÿ≠_ÿßŸÑÿÆŸäÿ± #ŸÇŸáŸàÿ© #ŸáÿØŸàÿ°", textOverlay: "ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ± Zowar", likes: 950, commentsCount: 45, mediaUrl: "https://source.unsplash.com/random/600x800?coffee,city,morning", postComments: [] },
            ];
            const mockChats = [
                { id: 1, userId: "user2", lastMessage: "ÿ®ÿßŸÑÿ™ÿ£ŸÉŸäÿØÿå ÿßŸÑŸÅŸÉÿ±ÿ© ÿ™ÿ®ÿØŸà ÿ±ÿßÿ¶ÿπÿ©!", unread: 2, online: true },
                { id: 2, userId: "user3", lastMessage: "ŸáŸÑ ÿ¨ÿ±ÿ®ÿ™ ÿßŸÑŸàÿµŸÅÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©ÿü", unread: 1, online: true },
            ];

            // --- Initial Setup ---
            auth.signInAnonymously() // Mock Firebase Auth
                .then(() => {
                    console.log("User signed in anonymously (mock)");
                    // Proceed with app initialization that might depend on auth
                })
                .catch((error) => {
                    console.error("Anonymous sign-in failed (mock):", error);
                });

            setTimeout(() => { splashScreen.classList.add('hidden'); }, 2800);
            setActiveSection('home-section'); 
            loadDarkModePreference();
            initializeSounds();
            populateCurrentUserProfile(); 
            updateUnreadMessagesBadge();
            populateStories(); 
            populateZowarSpaces(); 
            populateGeoRooms(); 
            populateActiveUsersInMessages();

            // --- UI Population & Event Listeners ---
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    playUiClickSound();
                    const sectionId = item.dataset.section;
                    setActiveSection(sectionId, sectionId === "create-post-section");
                    if (sectionId === 'profile-section' && item.dataset.userId === 'currentUser') {
                        populateCurrentUserProfile();
                    }
                });
            });
            
            messagesHeaderBtn.addEventListener('click', () => {
                playUiClickSound();
                setActiveSection(null); 
                messagesView.classList.add('active');
                chatListView.style.display = 'block'; 
                chatView.style.display = 'none'; 
                unreadMessagesCount = 0; 
                updateUnreadMessagesBadge();
            });
            
            if(backToMainFromMessagesBtn) { 
                backToMainFromMessagesBtn.addEventListener('click', () => {
                    playUiClickSound();
                    messagesView.classList.remove('active');
                    setActiveSection('home-section'); 
                });
            }

            // --- Sound Initialization & Playback ---
            function initializeSounds() {
                try {
                    uiClickSynth = new Tone.PluckSynth({ volume: masterVolume + 8, attackNoise: 0.05, dampening: 5000, resonance: 0.01 }).toDestination(); 
                    notificationSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.12, sustain: 0.05, release: 0.3 }, volume: masterVolume - 2 }).toDestination(); 
                    messageSendSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.08, sustain: 0.01, release: 0.1 }, volume: masterVolume + 2 }).toDestination(); 
                    postSentSynth = new Tone.Synth({ oscillator: {type: "amsine", harmonicity: 1.2 }, envelope: { attack: 0.02, decay: 0.25, sustain: 0.05, release: 0.35 }, volume: masterVolume -1 }).toDestination(); 
                    gameSelectSynth = new Tone.Synth({ oscillator: {type: "pulse", width: 0.6}, envelope: { attack: 0.01, decay: 0.1, sustain:0.05, release: 0.2}, volume: masterVolume }).toDestination();
                    diceRollSynth = new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.005, decay: 0.15, sustain: 0 }, volume: masterVolume -5 }).toDestination();
                    basketballShootSynth = new Tone.Synth({ oscillator: {type: "sawtooth"}, envelope: {attack:0.01, decay:0.1, sustain:0.05, release:0.1}, volume: masterVolume -3}).toDestination(); 
                    quizCorrectSynth = new Tone.Synth({ oscillator: {type: "triangle"}, envelope: {attack:0.01, decay:0.1, sustain:0.1, release:0.1}, volume: masterVolume }).toDestination(); 
                    quizWrongSynth = new Tone.Synth({ oscillator: {type: "square"}, envelope: {attack:0.01, decay:0.2, sustain:0, release:0.1}, volume: masterVolume -3 }).toDestination(); 


                    callRingingSynth = new Tone.Loop(time => { 
                        new Tone.Synth({ oscillator: { type: "pulse", width: 0.35 }, envelope: { attack: 0.01, decay: 0.28, sustain: 0, release: 0.1 }, volume: masterVolume - 3 }).toDestination().triggerAttackRelease("B5", "8n", time);
                        new Tone.Synth({ oscillator: { type: "pulse", width: 0.35 }, envelope: { attack: 0.01, decay: 0.28, sustain: 0, release: 0.1 }, volume: masterVolume - 3 }).toDestination().triggerAttackRelease("F#5", "8n", time + 0.35);
                    }, "1.25s");
                    callingProgressSynth = new Tone.Loop(time => {
                         new Tone.Synth({ oscillator: { type: "pwm", modulationFrequency: 0.35 }, envelope: { attack: 0.025, decay: 0.65, sustain: 0, release: 0.1 }, volume: masterVolume - 5 }).toDestination().triggerAttackRelease("G#4", "1n", time);
                    }, "1.9s");
                    Tone.Transport.start();
                } catch (err) { console.warn("Tone.js synths could not be initialized.", err); }
            }
            function playSound(synth, note, duration) { 
                if (synth && Tone.context.state === 'running') {
                    try { synth.triggerAttackRelease(note, duration); } catch (e) { console.warn("Sound play failed", e); }
                } else if (synth && Tone.context.state !== 'running') {
                    Tone.start().then(() => { if (synth) synth.triggerAttackRelease(note, duration); }).catch(e => console.warn("Tone.start() failed", e));
                }
            }
            function playUiClickSound() { playSound(uiClickSynth, "E6", "100n"); } 
            function playNotificationSound() { playSound(notificationSynth, "G6", "12n"); } 
            function playMessageSendSound() { playSound(messageSendSynth, "B5", "50n"); }
            function playPostSentSound() { playSound(postSentSynth, "D5", "6n"); }
            function playGameSelectSound() { playSound(gameSelectSynth, "F#4", "16n"); }
            function playDiceRollSound() { if (diceRollSynth && Tone.context.state === 'running') diceRollSynth.triggerAttackRelease("0.15"); else if (diceRollSynth) Tone.start().then(()=>diceRollSynth.triggerAttackRelease("0.15")); }
            function playBasketballShootSound() { playSound(basketballShootSynth, "C4", "8n"); setTimeout(() => playSound(basketballShootSynth, "G3", "8n"), 80); } 
            function playQuizCorrectSound() { playSound(quizCorrectSynth, "C5", "16n"); setTimeout(()=> playSound(quizCorrectSynth, "E5", "16n"),100); setTimeout(()=> playSound(quizCorrectSynth, "G5", "16n"),200);}
            function playQuizWrongSound() { playSound(quizWrongSynth, "C3", "4n");}

            function startCallRingingSound() { if (callRingingSynth && Tone.context.state === 'running') callRingingSynth.start(0); else if (callRingingSynth) Tone.start().then(()=>callRingingSynth.start(0));}
            function stopCallRingingSound() { if (callRingingSynth) callRingingSynth.stop(0); }
            function startCallingProgressSound() { if (callingProgressSynth && Tone.context.state === 'running') callingProgressSynth.start(0); else if(callingProgressSynth) Tone.start().then(()=>callingProgressSynth.start(0));}
            function stopCallingProgressSound() { if (callingProgressSynth) callingProgressSynth.stop(0); }
            document.body.addEventListener('click', () => {
                if (Tone.context.state !== 'running') { Tone.start().catch(e => console.warn("Tone.start() on body click failed", e)); }
            }, { once: true });

            // --- Dark Mode ---
            function loadDarkModePreference() {
                const darkModeToggle = getEl('dark-mode-toggle');
                if (localStorage.getItem('darkModeZowar') === 'true' || (!localStorage.getItem('darkModeZowar') && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
                    document.body.classList.add('dark-mode');
                    if (darkModeToggle) {
                        const span = darkModeToggle.querySelector('span');
                        if (span) span.style.transform = 'translateX(1.75rem)';
                    }
                }
            }
            darkModeToggleBtn.addEventListener('click', () => {
                playUiClickSound();
                document.body.classList.toggle('dark-mode');
                const span = darkModeToggleBtn.querySelector('span');
                if (span) {
                    span.style.transform = document.body.classList.contains('dark-mode') ? 'translateX(1.75rem)' : 'translateX(0px)';
                }
                localStorage.setItem('darkModeZowar', document.body.classList.contains('dark-mode'));
            });

            // --- Alert Banner ---
            function showAlert(message, type = 'info') { 
                alertMessage.textContent = message;
                alertBanner.className = 'alert-banner'; 
                if (type === 'success') alertBanner.style.backgroundColor = 'var(--accent-secondary-global)';
                else if (type === 'error') alertBanner.style.backgroundColor = 'var(--danger-color-global)';
                else alertBanner.style.backgroundColor = 'var(--accent-primary-global)'; 

                alertBanner.classList.add('show');
                setTimeout(() => {
                    alertBanner.classList.remove('show');
                }, 3000);
            }
            
            // --- Stories ---
            function populateStories() {
                if (!storiesContainer) return;
                storiesContainer.innerHTML = ''; 
                mockUsers.slice(0,5).forEach((user, index) => {
                    const storyEl = document.createElement('div');
                    storyEl.className = 'story-circle flex-shrink-0';
                    storyEl.innerHTML = `<img src="${user.avatar}" alt="Story by ${user.displayName}">`;
                    storiesContainer.appendChild(storyEl);
                });
                const addStoryEl = document.createElement('div');
                addStoryEl.className = 'story-circle flex-shrink-0 flex items-center justify-center border-dashed border-gray-400 dark:border-gray-600';
                addStoryEl.style.borderImage = 'none';
                addStoryEl.innerHTML = `<span class="text-3xl text-gray-400 dark:text-gray-500">+</span>`;
                storiesContainer.appendChild(addStoryEl);
            }
            
            // --- Zowar Spaces & Geo Rooms (Explore Section) ---
            function populateZowarSpaces() {
                if (!zowarSpacesContainer) return;
                zowarSpacesContainer.innerHTML = ''; 

                const mockSpaces = [
                    { title: "ŸÜŸÇÿßÿ¥ÿßÿ™ ÿ≠ŸàŸÑ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ü§ñ", host: "ÿØ. ÿÆÿßŸÑÿØ", listeners: 78, live: true, avatars: ["https://source.unsplash.com/random/24x24?man,tech", "https://source.unsplash.com/random/24x24?woman,scientist", "https://source.unsplash.com/random/24x24?person,glasses"] },
                    { title: "ÿ£ŸÖÿ≥Ÿäÿ© ÿ¥ÿπÿ±Ÿäÿ© ŸÖÿπ ŸÜÿ¨ŸàŸÖ ÿßŸÑŸÉŸÑŸÖÿ© üìú", host: "ÿ£ŸÖŸÑ ÿßŸÑÿ¥ÿßÿπÿ±ÿ©", listeners: 120, live: true, avatars: ["https://source.unsplash.com/random/24x24?woman,poet", "https://source.unsplash.com/random/24x24?man,book", "https://source.unsplash.com/random/24x24?person,elegant"] }
                ];
                mockSpaces.forEach(space => {
                    const spaceEl = document.createElement('div');
                    spaceEl.className = 'zowar-space-card';
                    let avatarHTML = space.avatars.map((avatar, idx) => `<img src="${avatar}" class="w-6 h-6 rounded-full border-2 border-white/50 ${idx > 0 ? '-mr-2 rtl:-ml-2 rtl:mr-0' : ''}">`).join('');
                    spaceEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-md mb-1">${space.title}</h4>
                                <p class="text-xs opacity-80">ŸÖÿπ <span class="font-semibold">${space.host}</span></p>
                            </div>
                            ${space.live ? '<span class="text-xs bg-red-500 px-2.5 py-1 rounded-full font-semibold shadow">ŸÖÿ®ÿßÿ¥ÿ±</span>' : ''}
                        </div>
                        <div class="mt-3 flex items-center space-x-2 rtl:space-x-reverse">
                            ${avatarHTML}
                            <span class="text-xs opacity-70">+ ${space.listeners} ŸÖÿ≥ÿ™ŸÖÿπ</span>
                        </div>`;
                    zowarSpacesContainer.appendChild(spaceEl);
                });
                const startSpaceBtn = document.createElement('button');
                startSpaceBtn.className = 'btn btn-secondary w-full mt-3 text-sm';
                startSpaceBtn.innerHTML = 'üé§ ÿßÿ®ÿØÿ£ ÿ∫ÿ±ŸÅÿ© ÿµŸàÿ™Ÿäÿ©';
                zowarSpacesContainer.appendChild(startSpaceBtn);
            }

            function populateGeoRooms() {
                if(!geoRoomsGrid) return;
                geoRoomsGrid.innerHTML = ''; 

                const mockGeoRooms = [
                    { name: "ŸÖÿ¨ÿ™ŸÖÿπ ÿ£ŸáŸÑ ÿßŸÑÿ≠Ÿä üè°", members: 23, gradient: "from-[var(--accent-primary-global)] to-[#1E40AF]" },
                    { name: "ÿπÿ¥ÿßŸÇ ÿßŸÑŸÇŸáŸàÿ© ‚òï", members: 45, gradient: "from-[var(--accent-secondary-global)] to-[#2A8588]" },
                ];
                mockGeoRooms.forEach(room => {
                    const roomEl = document.createElement('div');
                    roomEl.className = `p-5 rounded-xl text-white shadow-xl bg-gradient-to-br ${room.gradient} transition-transform hover:scale-[1.02] cursor-pointer`;
                    roomEl.innerHTML = `
                        <h3 class="font-bold text-md mb-1">${room.name}</h3>
                        <p class="text-xs opacity-80">${room.members} ÿπÿ∂Ÿà ŸÜÿ¥ÿ∑ ÿßŸÑÿ¢ŸÜ</p>`;
                    geoRoomsGrid.appendChild(roomEl);
                });
            }
            
            // --- Posts Feed ---
            function populatePostsFeed() {
                postsFeed.innerHTML = ''; 
                mockPosts.slice().reverse().forEach(postData => { 
                    const user = mockUsers.find(u => u.id === postData.userId) || {username: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ", displayName: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ", avatar: "https://placehold.co/40x40/cccccc/FFFFFF?text=?"};
                    const postElement = document.createElement('div');
                    postElement.className = 'post-card';
                    postElement.dataset.postId = postData.id;
                    postElement.innerHTML = `
                        <div class="p-3 flex items-center space-x-3 rtl:space-x-reverse">
                            <img src="${user.avatar}" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="font-semibold text-sm text-gray-800 dark:text-gray-200">${user.displayName}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">@${user.username}</p>
                            </div>
                        </div>
                        <div class="post-media-container">
                            ${postData.type === 'image' ? `<img src="${postData.mediaUrl}" alt="Post media">` : `<video src="${postData.mediaUrl}" controls class="w-full h-auto max-h-[60vh] object-contain"></video>`}
                            ${postData.textOverlay ? `<div class="post-text-overlay">${postData.textOverlay}</div>` : ''}
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed mb-2">${postData.caption}</p>
                            ${postData.hasAiHighlight ? '<button class="ai-highlight-btn text-xs bg-[var(--highlight-gold-global)] text-black px-2 py-0.5 rounded-md font-semibold hover:opacity-90">‚ú® ŸÖŸÑÿÆÿµ AI</button>' : ''}
                        </div>
                        <div class="post-actions">
                            <button class="like-btn">‚ù§ <span class="text-xs ml-1">${postData.likes}</span></button>
                            <button class="comment-btn" data-post-id="${postData.id}">üí¨ <span class="text-xs ml-1">${postData.commentsCount}</span></button>
                            <button>‚û•</button>
                        </div>
                    `;
                    postsFeed.appendChild(postElement);
                });
            }
            postsFeed.addEventListener('click', (e) => {
                if (e.target.closest('.ai-highlight-btn')) {
                    playUiClickSound();
                    document.getElementById('ai-summary-text').textContent = "Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± Ÿäÿπÿ±ÿ∂ ŸÑŸÇÿ∑ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ©ÿå ŸÖÿπ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÇŸäŸÇÿ©. ŸäŸÜÿµÿ≠ ÿ®Ÿá ŸÑŸÑŸÖŸáÿ™ŸÖŸäŸÜ ÿ®ÿßŸÑÿ¨ŸàÿØÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ©!";
                    aiHighlightModal.classList.add('active');
                }
                const likeBtn = e.target.closest('.like-btn');
                if (likeBtn) {
                    playUiClickSound();
                    likeBtn.classList.toggle('liked');
                }
                const commentBtn = e.target.closest('.comment-btn');
                if (commentBtn) {
                    playUiClickSound();
                    currentOpenPostIdForComment = commentBtn.dataset.postId;
                    populatePostComments(currentOpenPostIdForComment);
                    postCommentsModal.classList.add('active');
                }
            });
            if(closeAiHighlightModalBtn) closeAiHighlightModalBtn.addEventListener('click', () => { playUiClickSound(); aiHighlightModal.classList.remove('active'); });

            // --- Post Comments Modal ---
            function populatePostComments(postId) {
                postCommentsList.innerHTML = '';
                const post = mockPosts.find(p => p.id == postId);
                if (post && post.postComments) {
                    post.postComments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment-item flex items-start space-x-2 rtl:space-x-reverse';
                        const commenter = mockUsers.find(u => u.displayName === comment.user) || { avatar: "https://placehold.co/32x32/cccccc/FFFFFF?text=?" };
                        commentDiv.innerHTML = `
                            <img src="${commenter.avatar}" class="w-8 h-8 rounded-full mt-1">
                            <div>
                                <span class="font-semibold text-sm text-gray-800 dark:text-gray-200">${comment.user}</span>
                                <p class="text-xs text-gray-600 dark:text-gray-400">${comment.text}</p>
                            </div>`;
                        postCommentsList.appendChild(commentDiv);
                    });
                }
                if (postCommentsList.innerHTML === '') {
                    postCommentsList.innerHTML = '<p class="text-sm text-center text-gray-500 dark:text-gray-400">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ®ÿπÿØ. ŸÉŸÜ ÿ£ŸàŸÑ ŸÖŸÜ ŸäÿπŸÑŸÇ!</p>';
                }
            }
            submitPostCommentBtn.addEventListener('click', () => {
                const commentText = newPostCommentInput.value.trim();
                if (commentText && currentOpenPostIdForComment) {
                    playMessageSendSound();
                    const post = mockPosts.find(p => p.id == currentOpenPostIdForComment);
                    const currentUser = mockUsers.find(u => u.id === "currentUser");
                    if (post && currentUser) {
                        post.postComments.push({ user: currentUser.displayName, text: commentText });
                        post.commentsCount++; 
                        populatePostComments(currentOpenPostIdForComment); 
                        const postCardCommentBtn = postsFeed.querySelector(`.post-card[data-post-id="${currentOpenPostIdForComment}"] .comment-btn span`);
                        if (postCardCommentBtn) postCardCommentBtn.textContent = post.commentsCount;
                        currentUser.comments.push({postId: currentOpenPostIdForComment, text: commentText});
                    }
                    newPostCommentInput.value = '';
                }
            });
            if(closePostCommentsModalBtn) closePostCommentsModalBtn.addEventListener('click', () => { playUiClickSound(); postCommentsModal.classList.remove('active'); });

            // --- Create Post Modal ---
            nextToTextOverlayBtn.addEventListener('click', () => {
                playUiClickSound();
                const file = mediaUploadInput.files[0];
                if (file) {
                    uploadedMediaFile = file; 
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (file.type.startsWith('image/')) {
                            postPreviewImage.src = e.target.result;
                            postPreviewImage.style.display = 'block';
                            postPreviewVideo.style.display = 'none';
                        } else if (file.type.startsWith('video/')) {
                            postPreviewVideo.src = e.target.result;
                            postPreviewVideo.style.display = 'block';
                            postPreviewImage.style.display = 'none';
                        }
                        postPreviewPlaceholder.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                    createPostStep1.style.display = 'none';
                    createPostStep2.style.display = 'block';
                } else {
                    showAlert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ© ÿ£Ÿà ŸÅŸäÿØŸäŸà ÿ£ŸàŸÑÿßŸã.", "error");
                }
            });
            backToMediaUploadBtn.addEventListener('click', () => {
                playUiClickSound();
                createPostStep2.style.display = 'none';
                createPostStep1.style.display = 'block';
                previewTextOverlay.style.display = 'none'; 
            });
            postTextInput.addEventListener('input', (e) => {
                const text = e.target.value;
                if (text.trim() !== '') {
                    previewTextOverlay.textContent = text;
                    previewTextOverlay.style.display = 'block';
                } else {
                    previewTextOverlay.style.display = 'none';
                }
            });
            generateCaptionBtn.addEventListener('click', async () => {
                playUiClickSound();
                captionLoadingSpinner.style.display = 'block';
                generateCaptionBtn.disabled = true;
                const mediaType = uploadedMediaFile ? (uploadedMediaFile.type.startsWith('image/') ? 'ÿµŸàÿ±ÿ©' : 'ŸÅŸäÿØŸäŸà') : 'ŸÖÿ≠ÿ™ŸàŸâ';
                const overlayText = postTextInput.value.trim();
                let prompt = `ÿßŸÇÿ™ÿ±ÿ≠ ÿ™ÿπŸÑŸäŸÇŸãÿß ÿ¨ÿ∞ÿßÿ®Ÿãÿß ŸÑŸÖŸÜÿ¥Ÿàÿ± ÿπŸÑŸâ Ÿàÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸàÿßÿµŸÑ ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπŸä. ŸÜŸàÿπ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ŸáŸà ${mediaType}.`;
                if (overlayText) {
                    prompt += ` ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ™ÿ±ÿßŸÉÿ® ÿπŸÑŸâ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ŸáŸà: "${overlayText}".`;
                }
                prompt += " ÿßÿ¨ÿπŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇ ŸÇÿµŸäÿ±Ÿãÿß ŸàŸÖŸÑŸáŸÖŸãÿß ŸàŸÖŸÜÿßÿ≥ÿ®Ÿãÿß ŸÑŸÑÿ´ŸÇÿßŸÅÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©ÿå Ÿàÿ£ÿ∂ŸÅ ÿ®ÿπÿ∂ ÿßŸÑŸáÿßÿ¥ÿ™ÿßÿ∫ÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©.";

                try {
                    const caption = await callGeminiForText(prompt);
                    postCaptionInput.value = caption;
                } catch (error) {
                    showAlert("ŸÅÿ¥ŸÑ ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿßŸÑÿ™ÿπŸÑŸäŸÇ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.", "error");
                } finally {
                    captionLoadingSpinner.style.display = 'none';
                    generateCaptionBtn.disabled = false;
                }
            });
            submitPostBtn.addEventListener('click', () => {
                const caption = postCaptionInput.value.trim();
                const textOverlay = postTextInput.value.trim();
                const currentUser = mockUsers.find(u => u.id === "currentUser");

                if (!uploadedMediaFile) { showAlert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± Ÿàÿ≥ÿßÿ¶ÿ∑ ŸÑŸÑŸÜÿ¥ÿ±!", "error"); return; }
                if (!caption) { showAlert("ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÉÿ™ÿßÿ®ÿ© ÿ™ÿπŸÑŸäŸÇ ŸÑŸÑŸÖŸÜÿ¥Ÿàÿ±.", "error"); return; }

                const newPost = {
                    id: mockPosts.length + 1, 
                    type: uploadedMediaFile.type.startsWith('image/') ? 'image' : 'video',
                    userId: currentUser.id,
                    caption: caption,
                    textOverlay: textOverlay || null,
                    likes: 0,
                    commentsCount: 0,
                    mediaUrl: URL.createObjectURL(uploadedMediaFile), 
                    postComments: []
                };
                mockPosts.push(newPost);
                currentUser.postsCount++;
                
                playPostSentSound();
                showAlert("ÿ™ŸÖ ŸÜÿ¥ÿ± ŸÖŸÜÿ¥Ÿàÿ±ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!", "success");
                populatePostsFeed(); 
                populateCurrentUserProfile(); 
                
                createPostStep2.style.display = 'none';
                createPostStep1.style.display = 'block';
                mediaUploadInput.value = '';
                postTextInput.value = '';
                postCaptionInput.value = '';
                postPreviewImage.style.display = 'none'; postPreviewImage.src = "#";
                postPreviewVideo.style.display = 'none'; postPreviewVideo.src = "";
                previewTextOverlay.style.display = 'none';
                postPreviewPlaceholder.style.display = 'block';
                uploadedMediaFile = null;
                
                setActiveSection('home-section'); 
            });


            // --- Chat & Messages ---
            function updateUnreadMessagesBadge() {
                if (unreadMessagesCount > 0) {
                    unreadMessagesBadge.textContent = unreadMessagesCount;
                    unreadMessagesBadge.style.display = 'flex';
                } else {
                    unreadMessagesBadge.style.display = 'none';
                }
            }
             function populateActiveUsersInMessages() {
                if (!activeUsersMessagesContainer) return;
                activeUsersMessagesContainer.innerHTML = '';
                mockUsers.filter(u => u.id !== "currentUser" && mockChats.some(c => c.userId === u.id && c.online)).slice(0, 5)
                    .forEach(user => {
                        const userEl = document.createElement('div');
                        userEl.className = 'active-user-avatar text-center flex-shrink-0 w-16';
                        userEl.innerHTML = `
                            <img src="${user.avatar}" alt="${user.displayName}" class="mx-auto story-circle border-[var(--accent-secondary-global)]">
                            <p class="text-xs mt-1.5 text-gray-600 dark:text-gray-400 truncate">${user.displayName}</p>`;
                        activeUsersMessagesContainer.appendChild(userEl);
                    });
            }
            function populateChatList() {
                if(!chatListItems) return;
                chatListItems.innerHTML = '';
                mockChats.forEach(chatData => {
                    const user = mockUsers.find(u => u.id === chatData.userId) || {username: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≠ÿ∞ŸàŸÅ", displayName: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≠ÿ∞ŸàŸÅ", avatar: "https://placehold.co/50x50/cccccc/FFFFFF?text=X"};
                    const chatItem = document.createElement('div');
                    chatItem.className = 'p-4 flex items-center space-x-3 rtl:space-x-reverse hover:bg-gray-100 dark:hover:bg-gray-700/50 cursor-pointer transition-colors';
                    chatItem.dataset.chatId = chatData.id;
                    chatItem.innerHTML = `
                        <div class="relative">
                            <img src="${user.avatar}" alt="${user.displayName}" class="w-12 h-12 rounded-full">
                            ${chatData.online ? '<span class="absolute bottom-0 right-0 block w-3.5 h-3.5 bg-green-400 border-2 border-white dark:border-gray-800 rounded-full ring-1 ring-green-300 dark:ring-green-500"></span>' : ''}
                        </div>
                        <div class="flex-grow overflow-hidden">
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${user.displayName}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${chatData.lastMessage}</p>
                        </div>
                        ${chatData.unread > 0 ? `<div class="bg-[var(--accent-primary-global)] text-white text-xs rounded-full px-2.5 py-1 font-semibold">${chatData.unread}</div>` : ''}
                    `;
                    chatItem.addEventListener('click', () => openChat(chatData, user));
                    chatListItems.appendChild(chatItem);
                });
            }
            async function openChat(chatData, userData) {
                playUiClickSound();
                getEl('chat-view-avatar').src = userData.avatar;
                getEl('chat-view-name').textContent = userData.displayName;
                getEl('chat-view-status').textContent = chatData.online ? "ŸÜÿ¥ÿ∑ ÿßŸÑÿ¢ŸÜ" : "ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ";
                getEl('chat-view-status').className = `text-xs ${chatData.online ? 'text-green-500' : 'text-gray-500 dark:text-gray-400'}`;
                
                const messagesContainer = getEl('chat-messages');
                messagesContainer.innerHTML = ''; 
                addMessageToChat(`ÿ£ŸáŸÑÿßŸã ${userData.displayName}! ŸÉŸäŸÅ ÿ≠ÿßŸÑŸÉÿü`, false);
                addMessageToChat("ÿ£ŸÜÿß ÿ®ÿÆŸäÿ±ÿå ŸÖÿßÿ∞ÿß ÿπŸÜŸÉÿü", true);
                if(chatData.id === 1) addMessageToChat("ŸáŸÑ ŸäŸÖŸÉŸÜŸÜÿß ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ŸÖÿ¥ÿ±Ÿàÿπ ÿ≤Ÿàÿßÿ±ÿü", false);
                
                chatListView.style.display = 'none';
                chatView.style.display = 'flex';
                const lastReceivedMessage = messagesContainer.querySelectorAll('.chat-bubble.received:last-child')[0]?.textContent;
                if (lastReceivedMessage) {
                    await fetchSmartReplies(lastReceivedMessage);
                } else {
                    if(smartReplyContainer) smartReplyContainer.style.display = 'none';
                }
            }
            if(backToChatListBtn) backToChatListBtn.addEventListener('click', () => { playUiClickSound(); chatView.style.display = 'none'; chatListView.style.display = 'block'; if(smartReplyContainer) smartReplyContainer.style.display = 'none'; });
            if(sendMessageBtn) sendMessageBtn.addEventListener('click', async () => {
                const messageText = messageInput.value.trim();
                if (messageText) {
                    addMessageToChat(messageText, true);
                    playMessageSendSound();
                    messageInput.value = '';
                    if(smartReplyContainer) smartReplyContainer.style.display = 'none'; 
                    
                    const replyText = "ÿ¨ŸÖŸäŸÑ ÿ¨ÿØÿßŸã! ÿ£ÿ™ŸÅŸÇ ŸÖÿπŸÉ.";
                    setTimeout(async () => { 
                        addMessageToChat(replyText, false); 
                        playNotificationSound(); 
                        unreadMessagesCount++; 
                        updateUnreadMessagesBadge();
                        await fetchSmartReplies(replyText);
                    }, 1500);
                }
            });
            if(messageInput) messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessageBtn.click(); } });
            if(voiceNoteBtn) voiceNoteBtn.addEventListener('click', () => {
                playUiClickSound();
                if (!isRecording) {
                    isRecording = true;
                    voiceRecordingIndicator.style.display = 'flex';
                    voiceNoteBtn.innerHTML = 'üõë'; 
                    voiceRecordSeconds = 0;
                    voiceTimer.textContent = '0:00';
                    voiceRecordInterval = setInterval(() => {
                        voiceRecordSeconds++;
                        const minutes = Math.floor(voiceRecordSeconds / 60);
                        const seconds = voiceRecordSeconds % 60;
                        voiceTimer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    }, 1000);
                } else {
                    isRecording = false;
                    voiceRecordingIndicator.style.display = 'none';
                    voiceNoteBtn.innerHTML = 'üéôÔ∏è'; 
                    clearInterval(voiceRecordInterval);
                    addMessageToChat(`ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿµŸàÿ™Ÿäÿ© (${voiceTimer.textContent})`, true, true);
                    playMessageSendSound(); 
                }
            });
            function addMessageToChat(text, isSent, isVoiceNote = false) {
                const messagesContainer = getEl('chat-messages');
                const bubble = document.createElement('div');
                if (isVoiceNote) {
                    bubble.className = `chat-bubble sent voice-note-bubble`;
                    bubble.innerHTML = `
                        <div class="waveform"><span></span><span></span><span></span><span></span></div>
                        <span>${text}</span>`;
                } else {
                    bubble.className = `chat-bubble ${isSent ? 'sent' : 'received'}`;
                    bubble.textContent = text;
                }
                messagesContainer.appendChild(bubble);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }


            // --- User Profiles & Search ---
            function populateUserProfile(userId, containerElement) {
                const user = mockUsers.find(u => u.id === userId);
                if (!user) { containerElement.innerHTML = '<p>ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.</p>'; return; }

                let profileHTML = `
                    <div class="profile-header-bg" style="background: var(${document.body.classList.contains('dark-mode') ? '--dark-profile-accent' : '--profile-accent'});"></div>
                    <div class="p-4 profile-avatar-container">
                        <div class="text-center">
                            <div class="relative inline-block profile-avatar">
                                <img src="${user.avatar}" alt="Profile Picture">
                                ${userId === "currentUser" ? '<span class="absolute bottom-1 right-1 block w-6 h-6 bg-green-400 border-2 border-white dark:border-gray-800 rounded-full ring-2 ring-green-300 dark:ring-green-500"></span>' : ''}
                            </div>
                            <h2 class="text-2xl font-extrabold text-gray-800 dark:text-gray-200 mt-3">${user.displayName}</h2>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">@${user.username}</p>
                            <p id="user-bio-text-${userId}" class="text-sm text-gray-600 dark:text-gray-300 mt-3 max-w-md mx-auto px-4">${user.bio}</p>
                            ${userId === "currentUser" ? '<button id="generate-bio-btn" class="mt-2 text-xs text-[var(--accent-secondary-global)] dark:text-[var(--dark-accent-secondary-global)] font-semibold hover:underline">‚ú® ÿ£ŸÜÿ¥ÿ¶ ŸÜÿ®ÿ∞ÿ© (AI)</button><div id="bio-loading-spinner" class="mt-1 text-xs text-gray-500 dark:text-gray-400" style="display:none;">ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ®ÿ∞ÿ©...</div>' : ''}
                        </div>
                        <div class="mt-6 grid grid-cols-3 gap-2 text-center p-4 bg-white dark:bg-gray-800/60 rounded-xl shadow-lg">
                            <div><p class="text-lg font-bold text-gray-800 dark:text-gray-200">${user.postsCount}</p><p class="text-xs text-gray-500 dark:text-gray-400">ŸÖŸÜÿ¥Ÿàÿ±</p></div>
                            <div><p class="text-lg font-bold text-gray-800 dark:text-gray-200">${user.followers}</p><p class="text-xs text-gray-500 dark:text-gray-400">ŸÖÿ™ÿßÿ®ÿπ</p></div>
                            <div><p class="text-lg font-bold text-gray-800 dark:text-gray-200">${user.following}</p><p class="text-xs text-gray-500 dark:text-gray-400">Ÿäÿ™ÿßÿ®ÿπ</p></div>
                        </div>
                        <div class="mt-6 space-y-3 px-2">`;

                if (userId === "currentUser") {
                    profileHTML += `
                        <button id="edit-display-name-btn" class="w-full p-3.5 bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-200 rounded-lg text-gray-700 dark:text-gray-200 font-semibold flex items-center justify-between text-sm transition-colors">
                            <span>ÿ™ÿπÿØŸäŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπÿ±ÿ∂</span> <span class="transform -scale-x-100 text-gray-400 dark:text-gray-500">‚ùÆ</span>
                        </button>
                        <button id="view-my-comments-btn" class="w-full p-3.5 bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-200 rounded-lg text-gray-700 dark:text-gray-200 font-semibold flex items-center justify-between text-sm transition-colors">
                            <span>ÿπÿ±ÿ∂ ÿ™ÿπŸÑŸäŸÇÿßÿ™Ÿä ÿßŸÑŸäŸàŸÖŸäÿ©</span> <span class="text-gray-400 dark:text-gray-500">üìù</span>
                        </button>
                        <div id="my-daily-comments-list" class="mt-3 p-3 bg-gray-50 dark:bg-gray-700/30 rounded-lg space-y-2" style="display:none;"></div>
                        <button id="settings-btn-profile" class="w-full p-3.5 bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-200 rounded-lg text-gray-700 dark:text-gray-200 font-semibold flex items-center justify-between text-sm transition-colors">
                            <span>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™</span> <span class="text-gray-400 dark:text-gray-500">‚öô</span>
                        </button>
                        <button class="w-full p-3.5 bg-red-50 dark:bg-red-900/40 dark:hover:bg-red-900/60 hover:bg-red-100 rounded-lg text-red-600 dark:text-red-400 font-semibold text-sm transition-colors">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>`;
                } else {
                     profileHTML += `
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <button class="w-full btn btn-primary text-sm">ŸÖÿ™ÿßÿ®ÿπÿ©</button>
                            <button class="w-full btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">ŸÖÿ±ÿßÿ≥ŸÑÿ©</button>
                        </div>
                        <button class="block-user-btn w-full btn btn-danger text-sm mt-2" data-user-id-to-block="${user.id}">ÿ≠ÿ∏ÿ± ${user.displayName}</button>`;
                }
                profileHTML += `</div></div>`; 
                containerElement.innerHTML = profileHTML;

                if (userId === "currentUser") {
                    getEl('settings-btn-profile')?.addEventListener('click', () => { playUiClickSound(); settingsModal.classList.add('active'); });
                    getEl('edit-display-name-btn')?.addEventListener('click', () => {
                        playUiClickSound();
                        showAlert("ŸäŸÖŸÉŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿßÿ≥ŸÖ ÿßŸÑÿπÿ±ÿ∂ ŸÖÿ±ÿ™ŸäŸÜ ŸÅŸÇÿ∑ ŸÉŸÑ 15 ŸäŸàŸÖŸãÿß. (Ÿáÿ∞Ÿá ŸÖÿ≠ÿßŸÉÿßÿ©)", "info");
                    });
                    getEl('view-my-comments-btn')?.addEventListener('click', toggleMyDailyComments);
                    getEl('generate-bio-btn')?.addEventListener('click', generateAiBio);
                } else {
                    containerElement.querySelector('.block-user-btn')?.addEventListener('click', (e) => {
                        playUiClickSound();
                        const userIdToBlock = e.target.dataset.userIdToBlock;
                        const userToBlock = mockUsers.find(u => u.id === userIdToBlock);
                        showAlert(`ÿ™ŸÖ ÿ≠ÿ∏ÿ± ${userToBlock.displayName} ÿ®ŸÜÿ¨ÿßÿ≠. (ŸÖÿ≠ÿßŸÉÿßÿ©)`, 'success');
                    });
                }
            }
            function populateCurrentUserProfile() { populateUserProfile("currentUser", userProfileContent); }
            function toggleMyDailyComments() {
                playUiClickSound();
                const commentsListDiv = getEl('my-daily-comments-list');
                const currentUser = mockUsers.find(u => u.id === "currentUser");
                if (commentsListDiv.style.display === 'none') {
                    commentsListDiv.innerHTML = ''; 
                    if (currentUser.comments && currentUser.comments.length > 0) {
                        currentUser.comments.forEach(comment => {
                             const post = mockPosts.find(p => p.id == comment.postId);
                             const postOwner = mockUsers.find(u => u.id === post?.userId);
                            const commentEl = document.createElement('div');
                            commentEl.className = 'text-xs p-2.5 bg-white dark:bg-gray-800 rounded-md shadow-sm';
                            commentEl.innerHTML = `ÿπŸÑŸÇÿ™ ÿπŸÑŸâ ŸÖŸÜÿ¥Ÿàÿ± ŸÑŸÄ <span class="font-semibold text-[var(--accent-secondary-global)]">${postOwner?.displayName || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</span>: <span class="italic">"${comment.text}"</span>`;
                            commentsListDiv.appendChild(commentEl);
                        });
                    } else {
                        commentsListDiv.innerHTML = '<p class="text-xs text-center text-gray-500 dark:text-gray-400 py-2">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ŸÑÿπÿ±ÿ∂Ÿáÿß.</p>';
                    }
                    commentsListDiv.style.display = 'block';
                } else {
                    commentsListDiv.style.display = 'none';
                }
            }

            openSearchModalBtn.addEventListener('click', () => { playUiClickSound(); searchModal.classList.add('active'); userSearchInput.focus(); });
            closeSearchModalBtn.addEventListener('click', () => { playUiClickSound(); searchModal.classList.remove('active'); });
            userSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                searchResultsContainer.innerHTML = '';
                if (searchTerm.length < 1) { 
                    searchResultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 dark:text-gray-400 py-4">ÿßŸÉÿ™ÿ® ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ...</p>';
                    return;
                }
                const results = mockUsers.filter(user => user.id !== "currentUser" && (user.username.toLowerCase().includes(searchTerm) || user.displayName.toLowerCase().includes(searchTerm)));
                if (results.length > 0) {
                    results.forEach(user => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'user-search-item';
                        resultDiv.dataset.userId = user.id;
                        resultDiv.innerHTML = `
                            <img src="${user.avatar}" alt="${user.displayName}">
                            <div>
                                <h4>${user.displayName}</h4>
                                <p>@${user.username}</p>
                            </div>`;
                        resultDiv.addEventListener('click', () => {
                            playUiClickSound();
                            populateUserProfile(user.id, otherUserProfileContent);
                            setActiveSection(null); 
                            otherUserProfileView.classList.add('active');
                            searchModal.classList.remove('active');
                        });
                        searchResultsContainer.appendChild(resultDiv);
                    });
                } else {
                    searchResultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 dark:text-gray-400 py-4">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.</p>';
                }
            });
            
            // --- Settings Modal ---
            if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', () => { playUiClickSound(); settingsModal.classList.remove('active'); });

            // --- Calling Screen ---
            if(callBtn) callBtn.addEventListener('click', () => { 
                playUiClickSound();
                const currentChatName = getEl('chat-view-name').textContent;
                const currentChatAvatar = getEl('chat-view-avatar').src;
                getEl('calling-name').textContent = currentChatName;
                getEl('calling-avatar').src = currentChatAvatar;
                getEl('calling-status-text').textContent = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...";
                callingScreen.style.display = 'flex';
                startCallingProgressSound();
                setTimeout(() => {
                    if (callingScreen.style.display === 'flex') {
                        getEl('calling-status-text').textContent = "Ÿäÿ±ŸÜ...";
                        stopCallingProgressSound();
                        startCallRingingSound();
                    }
                }, 3500); 
                 setTimeout(() => { 
                    if (callingScreen.style.display === 'flex') {
                         endCallBtn.click(); 
                    }
                }, 9000); 
             });
            if(endCallBtn) endCallBtn.addEventListener('click', () => {
                playUiClickSound();
                callingScreen.style.display = 'none';
                stopCallRingingSound();
                stopCallingProgressSound();
            });

            // --- Gemini API Helper ---
            async function callGeminiForText(promptText) {
                let chatHistory = [{ role: "user", parts: [{ text: promptText }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API Error: ${response.status}. ${errorData?.error?.message || 'Unknown error'}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected Gemini API response structure:", result);
                    throw new Error("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ≠ÿ™ŸàŸâ ÿµÿßŸÑÿ≠ ŸÅŸä ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© Gemini API.");
                }
            }
            
            // --- Gemini API Integrations ---
            if(generateIcebreakersBtn) generateIcebreakersBtn.addEventListener('click', () => { playUiClickSound(); fetchIcebreakers(); });
            async function fetchIcebreakers() { 
                loadingGemini.style.display = 'block';
                icebreakersSuggestionsDiv.innerHTML = '';
                geminiErrorMessageEl.style.display = 'none';
                generateIcebreakersBtn.disabled = true;
                generateIcebreakersBtn.classList.add('opacity-70', 'cursor-not-allowed');
                const prompt = "ÿßŸÇÿ™ÿ±ÿ≠ 3 ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÉÿ≥ÿ± ÿ¨ŸÖŸàÿØ ÿ£Ÿà ŸÖŸàÿßÿ∂Ÿäÿπ ŸÜŸÇÿßÿ¥ ÿ¥ŸäŸÇÿ© ŸàŸÖÿ®ÿ™ŸÉÿ±ÿ© ŸÑŸÖÿ¨ŸÖŸàÿπÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ŸÅŸä ÿ∫ÿ±ŸÅÿ© ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿ∫ÿ±ÿßŸÅŸäÿ© ŸäŸÑÿ™ŸÇŸàŸÜ ŸÑÿ£ŸàŸÑ ŸÖÿ±ÿ©. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©ÿå ÿÆŸÅŸäŸÅÿ©ÿå ŸÖŸÖÿ™ÿπÿ©ÿå ŸàŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑÿ´ŸÇÿßŸÅÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÖÿ™ŸÜŸàÿπÿ©. ÿßÿ¨ÿπŸÑŸáÿß ÿ™ÿ¥ÿ¨ÿπ ÿπŸÑŸâ ÿßŸÑÿ™ŸÅÿßÿπŸÑ ÿßŸÑÿ•Ÿäÿ¨ÿßÿ®Ÿä.";
                try {
                    const suggestionsText = await callGeminiForText(prompt);
                    const suggestionsArray = suggestionsText.split('\n').map(s => s.replace(/^\d+\.\s*/, '').trim()).filter(s => s);
                    if (suggestionsArray.length > 0) {
                        suggestionsArray.forEach(suggestion => {
                            const p = document.createElement('p');
                            p.className = 'gemini-suggestion-item';
                            p.textContent = "üí° " + suggestion;
                            icebreakersSuggestionsDiv.appendChild(p);
                        });
                    } else { icebreakersSuggestionsDiv.innerHTML = '<p class="text-slate-500 dark:text-slate-400">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™.</p>'; }
                } catch (error) {
                    console.error('Error fetching icebreakers:', error);
                    geminiErrorMessageEl.textContent = `ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}.`;
                    geminiErrorMessageEl.style.display = 'block';
                } finally {
                    loadingGemini.style.display = 'none';
                    generateIcebreakersBtn.disabled = false;
                    generateIcebreakersBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
             }

            async function fetchSmartReplies(lastMessage) {
                if (!lastMessage || !smartReplyContainer) { if(smartReplyContainer) smartReplyContainer.style.display = 'none'; return; }
                smartReplyContainer.innerHTML = '<p class="text-xs text-gray-400 dark:text-gray-500 py-1">‚ú® ÿ¨ÿßÿ±Ÿä ÿ™ŸàŸÑŸäÿØ ÿ±ÿØŸàÿØ ÿ∞ŸÉŸäÿ©...</p>';
                smartReplyContainer.style.display = 'flex'; 

                const prompt = `ÿßŸÇÿ™ÿ±ÿßÿ≠ 3 ÿ±ÿØŸàÿØ ŸÇÿµŸäÿ±ÿ© Ÿàÿ∞ŸÉŸäÿ© ÿπŸÑŸâ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÅŸä ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©: "${lastMessage}"`;
                try {
                    const repliesText = await callGeminiForText(prompt);
                    const repliesArray = repliesText.split('\n').map(s => s.replace(/^\d+\.\s*/, '').trim()).filter(s => s && s.length < 30).slice(0,3); 
                    smartReplyContainer.innerHTML = '';
                    if (repliesArray.length > 0) {
                        repliesArray.forEach(reply => {
                            const btn = document.createElement('button');
                            btn.className = 'smart-reply-btn';
                            btn.textContent = reply;
                            btn.onclick = () => {
                                playUiClickSound();
                                messageInput.value = reply;
                                messageInput.focus();
                                smartReplyContainer.style.display = 'none';
                            };
                            smartReplyContainer.appendChild(btn);
                        });
                    } else {
                        smartReplyContainer.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Error fetching smart replies:", error);
                    smartReplyContainer.style.display = 'none';
                }
            }
            
            async function generateAiBio() {
                playUiClickSound();
                const bioLoadingSpinner = getEl('bio-loading-spinner');
                const generateBioBtn = getEl('generate-bio-btn');
                const userBioText = getEl(`user-bio-text-currentUser`); 

                if (bioLoadingSpinner) bioLoadingSpinner.style.display = 'block';
                if (generateBioBtn) generateBioBtn.disabled = true;

                const currentUser = mockUsers.find(u => u.id === "currentUser");
                const prompt = `ÿ£ŸÜÿ¥ÿ¶ ŸÜÿ®ÿ∞ÿ© ÿ¥ÿÆÿµŸäÿ© (bio) ÿ¨ÿ∞ÿßÿ®ÿ© ŸàŸÖÿÆÿ™ÿµÿ±ÿ© ŸÑÿ≠ÿ≥ÿßÿ® ÿπŸÑŸâ Ÿàÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸàÿßÿµŸÑ ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπŸä ŸÑÿ¥ÿÆÿµ ÿßÿ≥ŸÖŸá "${currentUser.displayName}" Ÿàÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸá "@${currentUser.username}". ÿßÿ¨ÿπŸÑŸáÿß ÿ™ÿπŸÉÿ≥ ÿ¥ÿÆÿµŸäÿ© ŸÖÿ≠ÿ®ÿ© ŸÑŸÑÿ≠Ÿäÿßÿ© ŸàŸÖÿ¥ÿßÿ±ŸÉÿ© ŸÑŸÑÿ™ÿ¨ÿßÿ±ÿ®. ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©.`;
                try {
                    const newBio = await callGeminiForText(prompt);
                    if (userBioText) userBioText.textContent = newBio;
                    currentUser.bio = newBio; 
                    showAlert("ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ®ÿ∞ÿ© ÿ¥ÿÆÿµŸäÿ© ÿ¨ÿØŸäÿØÿ©!", "success");
                } catch (error) {
                    showAlert("ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ®ÿ∞ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.", "error");
                } finally {
                    if (bioLoadingSpinner) bioLoadingSpinner.style.display = 'none';
                    if (generateBioBtn) generateBioBtn.disabled = false;
                }
            }


            // --- Find Nearby People ---
            if(findNearbyPeopleCard) findNearbyPeopleCard.addEventListener('click', () => {
                playUiClickSound();
                nearbyPeopleResults.style.display = 'block';
                nearbyUsersList.innerHTML = ''; 
                const loadingIndicator = nearbyPeopleResults.querySelector('.loading-indicator');
                const loadingText = nearbyPeopleResults.querySelector('p');
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (loadingText) loadingText.style.display = 'block';

                setTimeout(() => { 
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (loadingText) loadingText.style.display = 'none';
                    const nearbyMockUsers = mockUsers.filter(u => u.id !== "currentUser").slice(0, 3); 
                    if (nearbyMockUsers.length > 0) {
                        nearbyMockUsers.forEach((user, index) => {
                            const distance = ["Ÿäÿ®ÿπÿØ 300 ŸÖÿ™ÿ±", "ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑÿ≠Ÿä", "Ÿäÿ®ÿπÿØ 1.2 ŸÉŸÖ"];
                            const userCard = document.createElement('div');
                            userCard.className = 'user-search-item p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md';
                            userCard.dataset.userId = user.id;
                            userCard.innerHTML = `
                                <img src="${user.avatar}" alt="${user.displayName}" class="w-12 h-12 rounded-full">
                                <div class="flex-grow">
                                    <h4 class="font-semibold text-md text-gray-800 dark:text-gray-200">${user.displayName}</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">@${user.username}</p>
                                    <p class="text-xs text-[var(--accent-secondary-global)] dark:text-[var(--dark-accent-secondary-global)] mt-1">${distance[index % distance.length]}</p>
                                </div>
                                <button class="btn btn-secondary btn-sm p-2 text-xs">ÿ™ŸàÿßÿµŸÑ</button>`;
                            userCard.addEventListener('click', (e) => {
                                if (!e.target.closest('button')) { 
                                    playUiClickSound();
                                    populateUserProfile(user.id, otherUserProfileContent);
                                    setActiveSection(null); 
                                    otherUserProfileView.classList.add('active');
                                }
                            });
                            nearbyUsersList.appendChild(userCard);
                        });
                    } else {
                        nearbyUsersList.innerHTML = '<p class="text-sm text-center text-gray-500 dark:text-gray-400 py-4">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ŸÇÿ±Ÿäÿ®ŸàŸÜ ÿ≠ÿßŸÑŸäŸãÿß.</p>';
                    }
                }, 2000);
            });
            
            // --- Games Section Logic ---
            if(gamesSection) {
                gamesSection.addEventListener('click', (e) => {
                    const gameCard = e.target.closest('.game-card');
                    if (gameCard) {
                        playGameSelectSound();
                        const gameType = gameCard.dataset.game;
                        openGameLobby(gameType);
                    }
                });
            }

            if(backToGamesListBtn) {
                backToGamesListBtn.addEventListener('click', () => {
                    playUiClickSound();
                    gameLobbyView.classList.remove('active');
                    setActiveSection('games-section');
                });
            }

            function openGameLobby(gameType) {
                setActiveSection(null); 
                gameLobbyView.classList.add('active');
                let gameName = "";
                let specificUIHTML = "";

                switch(gameType) {
                    case 'ludo':
                        gameName = "ŸäŸÑÿß ŸÑŸàÿØŸà";
                        specificUIHTML = `
                            <p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ÿßÿ≥ÿ™ÿπÿØ ŸÑŸÖŸàÿßÿ¨Ÿáÿ© ÿ≠ŸÖÿßÿ≥Ÿäÿ© ŸÅŸä ŸÑÿπÿ®ÿ© ÿßŸÑŸÑŸàÿØŸà ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸäÿ©!</p>
                            <div class="dice-container">
                                <div class="dice" id="ludo-dice">
                                    <div class="dice-face face-1">1</div> <div class="dice-face face-2">2</div>
                                    <div class="dice-face face-3">3</div> <div class="dice-face face-4">4</div>
                                    <div class="dice-face face-5">5</div> <div class="dice-face face-6">6</div>
                                </div>
                            </div>
                            <button id="roll-ludo-dice-btn" class="btn btn-primary w-full text-sm mt-2">üé≤ ÿßÿ±ŸÖŸä ÿßŸÑŸÜÿ±ÿØ</button>`;
                        break;
                    case 'dominoes':
                        gameName = "ÿØŸàŸÖŸäŸÜŸà";
                        specificUIHTML = `<p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿØŸàŸÖŸäŸÜŸàÿü ÿ±ÿ™ÿ® ŸÇÿ∑ÿπŸÉ ÿ®ÿ∞ŸÉÿßÿ°!</p> <img src="https://placehold.co/300x150/8E44AD/FFFFFF?text=Dominoes+Table" class="mx-auto rounded-lg shadow-md">`;
                        break;
                    case 'snakes-ladders':
                        gameName = "ÿ≠Ÿäÿ© ŸàÿØÿ±ÿ¨";
                        specificUIHTML = `
                            <p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ÿßŸÑÿ≠ÿ∏ ŸáŸà ÿµÿØŸäŸÇŸÉ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑŸÖÿ´Ÿäÿ±ÿ©! ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ´ÿπÿßÿ®ŸäŸÜ ŸàÿßÿµÿπÿØ ÿßŸÑÿ≥ŸÑÿßŸÑŸÖ.</p>
                            <div class="dice-container">
                                <div class="dice" id="snakes-dice">
                                    <div class="dice-face face-1">1</div> <div class="dice-face face-2">2</div>
                                    <div class="dice-face face-3">3</div> <div class="dice-face face-4">4</div>
                                    <div class="dice-face face-5">5</div> <div class="dice-face face-6">6</div>
                                </div>
                            </div>
                            <button id="roll-snakes-dice-btn" class="btn btn-primary w-full text-sm mt-2">üêç ÿßÿ±ŸÖŸä ÿßŸÑŸÜÿ±ÿØ</button>`;
                        break;
                    case 'basketball':
                        gameName = "ÿ±ŸÖŸäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ©";
                        specificUIHTML = `
                            <p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ÿßÿÆÿ™ÿ®ÿ± ÿØŸÇÿ™ŸÉ! ŸáŸÑ ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ´ŸÑÿßÿ´Ÿäÿ©ÿü</p>
                            <div class="basketball-court">
                                <div class="hoop"></div>
                                <div class="net"></div>
                                <div class="ball" id="basketball-ball"></div>
                            </div>
                            <button id="shoot-basketball-btn" class="btn btn-primary w-full text-sm mt-4">üèÄ ÿßÿ±ŸÖŸä ÿßŸÑŸÉÿ±ÿ©</button>`;
                        break;
                    case 'quiz':
                        gameName = "ÿ£ÿ≥ÿ¶ŸÑÿ© ÿπÿßŸÖÿ©";
                        specificUIHTML = `
                            <p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ÿ™ÿ≠ÿØŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ Ÿàÿ£ÿ¨ÿ® ÿπŸÑŸâ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ™ŸÜŸàÿπÿ©!</p>
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <p id="quiz-question" class="font-semibold text-center mb-3">ŸÖÿß ŸáŸä ÿπÿßÿµŸÖÿ© ŸÅÿ±ŸÜÿ≥ÿßÿü</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <button class="quiz-option-btn btn bg-gray-200 dark:bg-gray-600 text-sm p-2">ŸÑŸÜÿØŸÜ</button>
                                    <button class="quiz-option-btn btn bg-gray-200 dark:bg-gray-600 text-sm p-2 correct">ÿ®ÿßÿ±Ÿäÿ≥</button>
                                    <button class="quiz-option-btn btn bg-gray-200 dark:bg-gray-600 text-sm p-2">ÿ®ÿ±ŸÑŸäŸÜ</button>
                                    <button class="quiz-option-btn btn bg-gray-200 dark:bg-gray-600 text-sm p-2">ŸÖÿØÿ±ŸäÿØ</button>
                                </div>
                            </div>`;
                        break;
                    case 'challenges':
                         gameName = "ÿ™ÿ≠ÿØŸäÿßÿ™ Zowar";
                         specificUIHTML = `<p class="text-center text-sm text-gray-600 dark:text-gray-300 mb-4">ÿ£ŸÉŸÖŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© ŸàÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸÑŸÉÿ≥ÿ® ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™!</p><img src="https://placehold.co/300x150/F0B90B/000000?text=Challenges" class="mx-auto rounded-lg shadow-md">`;
                         break;
                    default:
                        gameName = "ŸÑÿπÿ®ÿ© ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅÿ©";
                        specificUIHTML = "<p>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß.</p>";
                }
                gameLobbyTitle.textContent = gameName;
                gameSpecificUI.innerHTML = specificUIHTML;

                if (gameType === 'ludo' && getEl('roll-ludo-dice-btn')) {
                    getEl('roll-ludo-dice-btn').onclick = () => rollDice('ludo-dice');
                }
                if (gameType === 'snakes-ladders' && getEl('roll-snakes-dice-btn')) {
                    getEl('roll-snakes-dice-btn').onclick = () => rollDice('snakes-dice');
                }
                if (gameType === 'basketball' && getEl('shoot-basketball-btn')) {
                    getEl('shoot-basketball-btn').onclick = shootBasketball;
                }
                if (gameType === 'quiz') {
                    querySelAll('.quiz-option-btn').forEach(btn => {
                        btn.onclick = (e) => checkQuizAnswer(e.target);
                    });
                }
                populateGameLobbyPlayers();
            }
            
            function rollDice(diceId) {
                playDiceRollSound();
                const dice = getEl(diceId);
                if (!dice) return;
                const randomNumber = Math.floor(Math.random() * 6) + 1;
                let xRand = (Math.floor(Math.random() * 4) + 1) * 90; 
                let yRand = (Math.floor(Math.random() * 4) + 1) * 90;
                dice.style.transform = `rotateX(${xRand}deg) rotateY(${yRand}deg)`;
                setTimeout(() => {
                    const faces = dice.querySelectorAll('.dice-face');
                    faces.forEach(f => f.style.fontWeight = 'normal');
                    const targetFace = dice.querySelector(`.face-${randomNumber}`);
                    if(targetFace) targetFace.style.fontWeight = 'bold'; 
                     showAlert(`ŸÑŸÇÿØ ÿ±ŸÖŸäÿ™ ${randomNumber}!`, 'info');
                }, 1000);
            }

            function shootBasketball() {
                playBasketballShootSound();
                const ball = getEl('basketball-ball');
                if (!ball) return;
                ball.classList.add('shooting');
                setTimeout(() => {
                    ball.classList.remove('shooting');
                    const didScore = Math.random() > 0.4; 
                    showAlert(didScore ? "ÿ±ÿßÿ¶ÿπ! ŸÑŸÇÿØ ÿ≥ÿ¨ŸÑÿ™ ŸÜŸÇÿ∑ÿ©! üèÄ" : "ÿ£ŸàŸá! ÿ≠ÿßŸàŸÑÿ™ ÿ¨ŸäÿØÿßŸã.", didScore ? 'success' : 'info');
                }, 700);
            }

            function checkQuizAnswer(selectedButton) {
                querySelAll('.quiz-option-btn').forEach(btn => btn.disabled = true); 
                if (selectedButton.classList.contains('correct')) {
                    playQuizCorrectSound();
                    selectedButton.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    selectedButton.classList.add('bg-green-500', 'text-white');
                    showAlert("ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©!", "success");
                } else {
                    playQuizWrongSound();
                    selectedButton.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    selectedButton.classList.add('bg-red-500', 'text-white');
                    showAlert("ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÅŸä ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä!", "error");
                }
            }

            function populateGameLobbyPlayers() {
                gameLobbyPlayers.innerHTML = '';
                const currentUser = mockUsers.find(u => u.id === "currentUser");
                const players = [currentUser, ...mockUsers.filter(u => u.id !== "currentUser").slice(0,3)]; 

                players.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'game-lobby-player text-gray-800 dark:text-gray-100'; 
                    playerDiv.innerHTML = `
                        <img src="${player.avatar}" alt="${player.displayName}">
                        <span>${player.displayName} ${index === 0 ? '(ÿ£ŸÜÿ™)' : ''}</span>
                        ${index > 0 ? '<button class="text-xs text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-300 mr-auto rtl:ml-auto rtl:mr-0">ÿ•ÿ≤ÿßŸÑÿ©</button>' : ''}`;
                    gameLobbyPlayers.appendChild(playerDiv);
                });
            }

             // --- Tutoring Section Logic ---
            if (tutoringSection) {
                tutoringSection.addEventListener('click', (e) => {
                    const card = e.target.closest('.tutoring-card');
                    if (card) {
                        playUiClickSound();
                        const subject = card.dataset.subject;
                        tutoringSubjectTitle.textContent = card.querySelector('h3').textContent;
                        tutoringSubjectContent.textContent = `ŸÖÿ≠ÿ™ŸàŸâ ÿ™ÿπŸÑŸäŸÖŸä ŸÑŸÄ ${card.querySelector('h3').textContent} ÿ≥Ÿäÿ∏Ÿáÿ± ŸáŸÜÿß. ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿØÿ±Ÿàÿ≥ÿå ŸÅŸäÿØŸäŸàŸáÿßÿ™ÿå ÿßÿÆÿ™ÿ®ÿßÿ±ÿßÿ™ÿå ÿ£Ÿà ÿ±ÿ®ÿ∑ ŸÖÿπ ŸÖÿØÿ±ÿ≥ŸäŸÜ ÿÆÿµŸàÿµŸäŸäŸÜ. (Ÿáÿ∞Ÿá ŸÖÿ≠ÿßŸÉÿßÿ©).`;
                        tutoringSubjectDetails.style.display = 'block';
                        tutoringSubjectDetails.scrollIntoView({behavior: 'smooth'});
                    }
                });
            }


            // --- Helper to set active section and hide others ---
            function setActiveSection(sectionId, isModalTrigger = false) {
                document.body.className = localStorage.getItem('darkModeZowar') === 'true' ? 'dark-mode' : ''; 

                if (!isModalTrigger || (isModalTrigger && !getEl(sectionId)?.classList.contains('modal-like-section'))) {
                    sections.forEach(s => s.classList.remove('active'));
                    views.forEach(v => v.classList.remove('active')); 
                }
                
                if (sectionId !== 'messages-view' && !isModalTrigger) {
                     messagesView.classList.remove('active');
                }

                if (sectionId) {
                    const targetElement = getEl(sectionId);
                    if (targetElement) {
                        targetElement.classList.add('active');
                        document.body.classList.add(`${sectionId}-theme`); 
                        
                        navItems.forEach(item => {
                            const itemSection = item.dataset.section;
                            const isActive = itemSection === sectionId;
                            item.classList.toggle('active', isActive);
                            const icon = item.querySelector('.nav-icon');
                            const text = item.querySelector('.nav-text');
                            
                            if(icon && text) {
                                let sectionBaseName = sectionId.split('-')[0];
                                let activeColorVar = `--${sectionBaseName}-accent`;
                                let activeColorVarDark = `--dark-${sectionBaseName}-accent`;
                                
                                // Fallback to global if section specific accent is not defined
                                let finalActiveColor = getComputedStyle(document.documentElement).getPropertyValue(activeColorVar).trim();
                                let finalActiveColorDark = getComputedStyle(document.documentElement).getPropertyValue(activeColorVarDark).trim();

                                if (!finalActiveColor) finalActiveColor = 'var(--accent-primary-global)';
                                if (!finalActiveColorDark) finalActiveColorDark = 'var(--dark-accent-primary-global)';

                                if(isActive) {
                                    icon.style.color = document.body.classList.contains('dark-mode') ? finalActiveColorDark : finalActiveColor;
                                    text.style.color = document.body.classList.contains('dark-mode') ? finalActiveColorDark : finalActiveColor;
                                } else {
                                    icon.style.color = ''; 
                                    text.style.color = ''; 
                                }
                            }
                             if (item.classList.contains('create-post-btn')) {
                                 item.classList.toggle('create-post-btn-active', itemSection === "create-post-section" && sectionId === "create-post-section");
                            }
                        });
                    }
                } else { 
                     navItems.forEach(item => {
                        item.classList.remove('active');
                        const icon = item.querySelector('.nav-icon');
                        const text = item.querySelector('.nav-text');
                        if(icon) icon.style.color = '';
                        if(text) text.style.color = '';
                     });
                     if (messagesView.classList.contains('active')) {
                        document.body.classList.add('messages-view-theme');
                     }
                }
            }
        });
    </script>
</body>
</html>
